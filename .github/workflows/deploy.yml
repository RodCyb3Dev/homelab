##############################################################################
# GITHUB ACTIONS - Deployment Pipeline
# Automated deployment to Hetzner server with zero-downtime updates
##############################################################################

name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.github/workflows/backup.yml'
      - '.github/workflows/security-scan.yml'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      
  schedule:
    # Daily updates at 02:00 UTC
    - cron: '0 2 * * *'

env:
  SSH_HOST: ${{ secrets.HETZNER_SSH_HOST }}
  SSH_USER: ${{ secrets.HETZNER_SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
  DEPLOY_PATH: /opt/homelab
  GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
  GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}

jobs:
  ##############################################################################
  # SECURITY SCANNING
  ##############################################################################
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Notify on critical findings
        if: failure()
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=üö® Security Scan Failed" \
            -F "message=Critical vulnerabilities found in deployment. Check GitHub Security tab." \
            -F "priority=10"

  ##############################################################################
  # VALIDATION
  ##############################################################################
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker-compose config > /dev/null
          echo "‚úÖ docker-compose.yml is valid"

      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint
          file_or_dir: config/
          strict: false

      - name: Validate Ansible playbook syntax
        run: |
          pip install ansible
          cd ansible
          ansible-playbook --syntax-check playbook.yml
          ansible-inventory --list

  ##############################################################################
  # PRE-DEPLOYMENT HEALTH CHECK
  ##############################################################################
  pre-deployment-check:
    name: Pre-Deployment Health Check
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Check current service health
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "üìä Checking service health..."
            docker-compose ps
            
            # Check if critical services are running
            if ! docker-compose ps | grep -q "traefik.*Up"; then
              echo "‚ö†Ô∏è Traefik is not running. Proceeding with caution..."
            fi
            
            # Create backup before deployment
            echo "üíæ Creating pre-deployment backup..."
            bash scripts/backup.sh pre-deployment
          EOF

  ##############################################################################
  # DEPLOY WITH ANSIBLE
  ##############################################################################
  deploy:
    name: Deploy to Hetzner with Ansible
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    environment:
      name: production
      url: https://grafana.rodneyops.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible

      - name: Configure SSH known_hosts for Ansible
        # Ansible automatically uses the SSH agent set up by webfactory/ssh-agent above
        # We just need to add the host to known_hosts to avoid host key verification prompts
        # No need to write the key file - SSH agent is sufficient
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ env.SSH_PORT }} ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy with Ansible
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          TZ: ${{ secrets.TIMEZONE }}
          PGID: ${{ secrets.PGID }}
          PUID: ${{ secrets.PUID }}
          STORAGE_BOX_PASSWORD: ${{ secrets.STORAGE_BOX_PASSWORD }}
          STORAGE_BOX_USER: ${{ secrets.STORAGE_BOX_USER }}
          STORAGE_BOX_HOST: ${{ secrets.STORAGE_BOX_HOST }}
          POSTGRESQL_PASSWORD: ${{ secrets.POSTGRESQL_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          CROWDSEC_ENROLL_KEY: ${{ secrets.CROWDSEC_ENROLL_KEY }}
          CROWDSEC_BOUNCER_KEY: ${{ secrets.CROWDSEC_BOUNCER_KEY }}
          GRAFANA_ADMIN_USER: ${{ secrets.GRAFANA_ADMIN_USER }}
          GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          GOTIFY_ADMIN_USER: ${{ secrets.GOTIFY_ADMIN_USER }}
          GOTIFY_ADMIN_PASSWORD: ${{ secrets.GOTIFY_ADMIN_PASSWORD }}
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
          TAILSCALE_DOMAIN: ${{ secrets.TAILSCALE_DOMAIN }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          LE_EMAIL_SSL: ${{ secrets.LE_EMAIL_SSL }}
          AUTHELIA_STORAGE_POSTGRESQL_PASSWORD: ${{ secrets.AUTHELIA_STORAGE_POSTGRESQL_PASSWORD }}
          AUTHELIA_JWT_SECRET: ${{ secrets.AUTHELIA_JWT_SECRET }}
          AUTHELIA_STORAGE_ENCRYPTION_KEY: ${{ secrets.AUTHELIA_STORAGE_ENCRYPTION_KEY }}
          AUTHELIA_SESSION_SECRET: ${{ secrets.AUTHELIA_SESSION_SECRET }}
          AUTHELIA_NOTIFIER_SMTP_PASSWORD: ${{ secrets.AUTHELIA_NOTIFIER_SMTP_PASSWORD }}
          BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT | default('587') }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          VPN_PRIVATE_KEY: ${{ secrets.VPN_PRIVATE_KEY }}
          VPN_ADDRESSES: ${{ secrets.VPN_ADDRESSES | default('10.2.0.2/32') }}
          VPN_PROVIDER: ${{ secrets.VPN_PROVIDER | default('protonvpn') }}
          VPN_COUNTRIES: ${{ secrets.VPN_COUNTRIES | default('Netherlands') }}
          JELLYFIN_PUBLISHED_URL: ${{ secrets.JELLYFIN_PUBLISHED_URL | default('https://jellyfin.kooka-lake.ts.net') }}
        run: |
          cd ansible
          ansible-playbook playbook.yml -v

      - name: Notify success
        if: success()
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=‚úÖ Deployment Successful" \
            -F "message=Successfully deployed to production at $(date)" \
            -F "priority=5"

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=‚ùå Deployment Failed" \
            -F "message=Deployment to production failed. Check GitHub Actions logs." \
            -F "priority=10"

  ##############################################################################
  # POST-DEPLOYMENT VERIFICATION
  ##############################################################################
  post-deployment-check:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Check service endpoints
        run: |
          echo "üîç Verifying service endpoints..."
          
          # Check Traefik
          curl -f -s https://traefik.rodneyops.com/ping || {
            echo "‚ùå Traefik health check failed"
            exit 1
          }
          
          # Check Grafana
          curl -f -s https://grafana.rodneyops.com/api/health || {
            echo "‚ùå Grafana health check failed"
            exit 1
          }
          
          # Check Authelia
          curl -f -s https://auth.rodneyops.com/api/health || {
            echo "‚ùå Authelia health check failed"
            exit 1
          }
          
          echo "‚úÖ All service endpoints are healthy!"

      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests..."
          # Add your smoke tests here
          echo "‚úÖ Smoke tests passed!"

  ##############################################################################
  # ROLLBACK (on failure)
  ##############################################################################
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, post-deployment-check]
    if: failure()
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute rollback
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            echo "‚èÆÔ∏è Executing rollback..."
            cd ${{ env.DEPLOY_PATH }}
            
            # Restore from backup
            bash scripts/restore.sh pre-deployment
            
            # Restart services
            docker-compose up -d
            
            echo "‚úÖ Rollback completed!"
          EOF

      - name: Notify rollback
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=‚èÆÔ∏è Deployment Rolled Back" \
            -F "message=Deployment failed and was rolled back to previous version." \
            -F "priority=10"

