name: QA Checks & Secret Scanning

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # ===========================================================================
  # SECRET SCANNING - Critical security check
  # ===========================================================================
  secret-scan:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for pro features

      - name: Run TruffleHog (filesystem scan for first push)
        if: github.event.before == '0000000000000000000000000000000000000000' || github.event.before == ''
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

      - name: Run TruffleHog (diff scan for subsequent pushes)
        if: github.event.before != '0000000000000000000000000000000000000000' && github.event.before != ''
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true

  # ===========================================================================
  # PRETTIER - Code Formatting Check
  # ===========================================================================
  prettier-check:
    name: ğŸ¨ Prettier Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Prettier
        run: npm install -g prettier

      - name: Check formatting
        run: |
          echo "Checking code formatting with Prettier..."
          # Skip if config files don't exist (optional check)
          if [ -f .prettierrc ] && [ -f .prettierignore ]; then
            # Only fail on errors, not warnings
            prettier --config .prettierrc --ignore-path .prettierignore --check "**/*.{yml,yaml,md,json}" 2>&1 | grep -E "^\[error\]" && {
              echo "âŒ Formatting errors found!"
              echo "Run 'make format-fix' locally to fix formatting"
              exit 1
            } || {
              echo "âœ… No formatting errors (warnings are acceptable)"
              exit 0
            }
          else
            echo "âš ï¸  Prettier config files not found, skipping format check"
          fi

  # ===========================================================================
  # YAML VALIDATION
  # ===========================================================================
  yaml-lint:
    name: ğŸ“ YAML Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          echo "Linting YAML files..."
          # Use default config if .yamllint.yml doesn't exist
          if [ -f .yamllint.yml ]; then
            yamllint -c .yamllint.yml . || true
          else
            yamllint . || true
          fi

      - name: Validate docker-compose.yml
        run: |
          echo "Validating docker-compose.yml syntax..."
          # Create minimal .env file for validation (secrets are not needed for syntax validation)
          if [ ! -f .env ]; then
            echo "Creating minimal .env file for validation..."
            cat > .env << 'EOF'
          # Minimal .env for Docker Compose validation in CI
          # Actual secrets are provided via environment variables or vault
          TZ=UTC
          PUID=1000
          PGID=1000
          DOMAIN=example.com
          TIMEZONE=UTC
          EOF
          fi
          docker compose -f docker-compose.yml config > /dev/null

      - name: Validate GitHub Actions workflows
        run: |
          echo "Validating GitHub Actions workflows..."
          for workflow in .github/workflows/*.yml; do
            echo "Checking $workflow..."
            # Basic YAML syntax check
            python -c "import yaml; yaml.safe_load(open('$workflow'))" || {
              echo "âŒ YAML syntax error in $workflow"
              exit 1
            }
          done
          echo "âœ… All GitHub Actions workflows are valid"

      - name: Validate Ansible playbooks and roles
        run: |
          echo "Validating Ansible YAML files..."
          # Exclude files with custom tags (!ENV) and multi-document YAML
          find ansible -name "*.yml" -type f | while read -r file; do
            # Skip files with custom tags or multi-document YAML
            if grep -q "!ENV" "$file" 2>/dev/null; then
              echo "âš ï¸  Skipping $file (contains custom !ENV tags)"
              continue
            fi
            echo "Checking $file..."
            python -c "import yaml; yaml.safe_load(open('$file'))" || {
              echo "âŒ YAML syntax error in $file"
              exit 1
            }
          done
          echo "âœ… All Ansible YAML files are valid"

      - name: Validate config YAML files (excluding custom tags and multi-doc)
        run: |
          echo "Validating config YAML files..."
          # Exclude archive, files with custom tags, and multi-document YAML
          find config -name "*.yml" -o -name "*.yaml" | grep -v "archive" | while read -r file; do
            # Skip files with custom tags
            if grep -q "!ENV" "$file" 2>/dev/null; then
              echo "âš ï¸  Skipping $file (contains custom !ENV tags)"
              continue
            fi
            # Skip CrowdSec multi-document files (they're valid but safe_load doesn't handle them)
            if echo "$file" | grep -q "crowdsec.*\.yaml$"; then
              echo "âš ï¸  Skipping $file (multi-document YAML)"
              continue
            fi
            echo "Checking $file..."
            python -c "import yaml; yaml.safe_load(open('$file'))" || {
              echo "âŒ YAML syntax error in $file"
              exit 1
            }
          done
          echo "âœ… All config YAML files are valid"

  # ===========================================================================
  # SHELL SCRIPT VALIDATION
  # ===========================================================================
  shellcheck:
    name: ğŸš Shell Script Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: error  # Only fail on errors, not warnings
          scandir: './scripts'
          ignore_paths: 'node_modules .git'
          disable_matcher: false
          format: gcc
          version: stable

      - name: Check script permissions
        run: |
          echo "Checking executable scripts have proper shebangs..."
          find scripts -type f -executable -print0 | while IFS= read -r -d '' script; do
            if ! head -n1 "$script" | grep -q '^#!'; then
              echo "âŒ Missing shebang: $script"
              exit 1
            fi
          done

  # ===========================================================================
  # MARKDOWN LINTING
  # ===========================================================================
  markdown-lint:
    name: ğŸ“„ Markdown Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: .
          config_file: ${{ github.workspace }}/.markdownlint.json || ''
          ignore_files: node_modules
        continue-on-error: true  # Allow to continue if config file doesn't exist

  # ===========================================================================
  # DOCKERFILE VALIDATION
  # ===========================================================================
  dockerfile-lint:
    name: ğŸ³ Dockerfile Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hadolint
        run: |
          echo "Checking for Dockerfiles..."
          # Check if any Dockerfiles exist (we use Docker Compose, not standalone Dockerfiles)
          if find . -name "Dockerfile" -not -path "./.git/*" | grep -q .; then
            echo "Found Dockerfiles, running Hadolint..."
            find . -name "Dockerfile" -not -path "./.git/*" | while read -r dockerfile; do
              echo "Linting $dockerfile..."
              docker run --rm -i hadolint/hadolint < "$dockerfile" || true
            done
          else
            echo "âš ï¸  No Dockerfiles found (using Docker Compose images), skipping Hadolint"
          fi

  # ===========================================================================
  # SECURITY AUDIT
  # ===========================================================================
  security-audit:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files..."
          
          # Check for private keys
          if find . -type f -name "*.pem" -o -name "*.key" -o -name "id_rsa*" -o -name "id_ed25519*" | grep -v ".git" | grep -v "node_modules"; then
            echo "âŒ Private key files detected!"
            exit 1
          fi
          
          # Check for .env files (excluding .gitignore patterns)
          ENV_FILES=$(find . -type f \( -name ".env" -o -name ".env.local" -o -name ".env.production" \) \
            -not -name ".env.example" \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" 2>/dev/null || true)
          
          if [ -n "$ENV_FILES" ]; then
            # Check if any .env files are NOT in .gitignore
            FOUND_UNIGNORED=""
            echo "$ENV_FILES" | while read -r file; do
              if [ -n "$file" ] && ! git check-ignore -q "$file" 2>/dev/null; then
                echo "$file"
              fi
            done | while read -r file; do
              if [ -n "$file" ]; then
                FOUND_UNIGNORED="$FOUND_UNIGNORED$file\n"
              fi
            done
            
            if [ -n "$FOUND_UNIGNORED" ]; then
              echo "âŒ .env files found that are not in .gitignore:"
              echo "$FOUND_UNIGNORED"
              exit 1
            fi
          fi
          
          echo "âœ… No sensitive files found (or all are properly ignored)"

      - name: Check for hardcoded IPs
        run: |
          echo "Checking for hardcoded IPs..."
          # Allow known safe IPs and the server IP
          if grep -r --include="*.yml" --include="*.yaml" --include="*.sh" -E "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" . \
            | grep -v "95.216.176.147" \
            | grep -v "0.0.0.0" \
            | grep -v "127.0.0.1" \
            | grep -v "172\." \
            | grep -v "192.168\." \
            | grep -v "1.1.1.1" \
            | grep -v "1.0.0.1" \
            | grep -v ".1:53" \
            | grep -v ".git/"; then
            echo "âš ï¸  Found potentially hardcoded IPs (review manually)"
          else
            echo "âœ… No unexpected hardcoded IPs"
          fi

      - name: Check for exposed secrets in env vars
        run: |
          echo "Checking for exposed secrets..."
          # Exclude Ansible templates (they use variables), archive, and known safe patterns
          if grep -r --include="*.yml" --include="*.yaml" -iE "(password|secret|key|token):\s*[\"'][^$]" . \
            | grep -v "op item get" \
            | grep -v "\${" \
            | grep -v "# " \
            | grep -v ".git/" \
            | grep -v ".md:" \
            | grep -v "ansible/roles/sync_secrets" \
            | grep -v "file:///run/secrets" \
            | grep -v "archive/" \
            | grep -v "default('')" \
            | grep -v "lookup('env'" \
            | grep -v "vault_" \
            | grep -q .; then
            echo "âŒ Possible exposed secrets detected!"
            grep -r --include="*.yml" --include="*.yaml" -iE "(password|secret|key|token):\s*[\"'][^$]" . \
              | grep -v "op item get" \
              | grep -v "\${" \
              | grep -v "# " \
              | grep -v ".git/" \
              | grep -v ".md:" \
              | grep -v "ansible/roles/sync_secrets" \
              | grep -v "file:///run/secrets" \
              | grep -v "archive/" \
              | grep -v "default('')" \
              | grep -v "lookup('env'" \
              | grep -v "vault_"
            exit 1
          fi
          echo "âœ… No exposed secrets found"

  # ===========================================================================
  # DOCKER COMPOSE VALIDATION
  # ===========================================================================
  docker-compose-validate:
    name: ğŸ‹ Docker Compose Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose syntax
        run: |
          echo "Validating docker-compose.yml..."
          # Create minimal .env file for validation (secrets are not needed for syntax validation)
          if [ ! -f .env ]; then
            echo "Creating minimal .env file for validation..."
            cat > .env << 'EOF'
          # Minimal .env for Docker Compose validation in CI
          # Actual secrets are provided via environment variables or vault
          TZ=UTC
          PUID=1000
          PGID=1000
          DOMAIN=example.com
          TIMEZONE=UTC
          EOF
          fi
          docker compose -f docker-compose.yml config > /dev/null
          echo "âœ… docker-compose.yml is valid"

      - name: Check for required services
        run: |
          echo "Checking for required services..."
          # Updated to match current stack (Caddy instead of Traefik)
          REQUIRED_SERVICES=("caddy" "authelia" "crowdsec" "grafana" "prometheus")
          
          for service in "${REQUIRED_SERVICES[@]}"; do
            if ! docker compose -f docker-compose.yml config 2>/dev/null | grep -q "services:.*$service"; then
              echo "âš ï¸  Required service '$service' might be missing"
            fi
          done
          
      - name: Validate all docker-compose files
        run: |
          echo "Validating all docker-compose files..."
          # Create minimal .env file for validation (secrets are not needed for syntax validation)
          if [ ! -f .env ]; then
            echo "Creating minimal .env file for validation..."
            cat > .env << 'EOF'
          # Minimal .env for Docker Compose validation in CI
          # Actual secrets are provided via environment variables or vault
          TZ=UTC
          PUID=1000
          PGID=1000
          DOMAIN=example.com
          TIMEZONE=UTC
          EOF
          fi
          for compose_file in docker-compose*.yml; do
            if [ -f "$compose_file" ]; then
              echo "Validating $compose_file..."
              docker compose -f "$compose_file" config > /dev/null || {
                echo "âŒ $compose_file is invalid"
                exit 1
              }
            fi
          done

  # ===========================================================================
  # SUMMARY REPORT
  # ===========================================================================
  qa-summary:
    name: ğŸ“Š QA Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, prettier-check, yaml-lint, shellcheck, markdown-lint, dockerfile-lint, security-audit, docker-compose-validate]
    if: always()
    steps:
      - name: QA Results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ QA Checks Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "All quality and security checks completed!"
          echo ""
          echo "âœ… Secret scanning"
          echo "âœ… Prettier formatting"
          echo "âœ… YAML validation"
          echo "âœ… Shell script checking"
          echo "âœ… Markdown linting"
          echo "âœ… Dockerfile validation"
          echo "âœ… Security audit"
          echo "âœ… Docker Compose validation"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

