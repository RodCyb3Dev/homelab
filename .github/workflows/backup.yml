##############################################################################
# GITHUB ACTIONS - Automated Backup Pipeline
# Daily backups using homelab_tools (BorgBackup) to remote repository
#
# Required GitHub Secrets:
#   - BORG_PASSPHRASE: Passphrase for BorgBackup repository encryption
#   - SSH_HOST: Server hostname/IP
#   - SSH_USER: SSH username
#   - SSH_PRIVATE_KEY: SSH private key for server access
#   - GOTIFY_URL: Gotify notification URL
#   - GOTIFY_TOKEN: Gotify notification token
#
# Note: Backup repository must be configured in homelab_tools config file
#       (~/.homelab/config.yaml or /opt/homelab/.homelab/config.yaml)
#
# Note: homelab_tools is installed in /opt/tools/ (separate from /opt/homelab/)
#       This keeps /opt/homelab/ clean for backups (only config files are backed up)
##############################################################################

name: Automated Backup

on:
  schedule:
    # Daily at 03:00 UTC
    - cron: '0 3 * * *'
 
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - config-only
          - database-only

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
  DEPLOY_PATH: /opt/homelab
  GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
  GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}

jobs:
  ##############################################################################
  # BACKUP JOB
  ##############################################################################
  backup:
    name: Execute Backup
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Sync systemd files before backup
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            set -e
            echo "ðŸ”„ Syncing systemd files to /opt/homelab/systemd/..."
            cd ${{ env.DEPLOY_PATH }}
            
            # Sync systemd files from /etc/systemd/system/ to /opt/homelab/systemd/
            python3 -m homelab_tools storage sync-systemd || echo "âš ï¸  No systemd files to sync (this is OK if none exist)"
          EOF

      - name: Execute backup using homelab_tools
        id: backup
        env:
          BORG_PASSPHRASE: ${{ secrets.BORG_PASSPHRASE }}
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            set -e

            echo "ðŸ’¾ Starting backup process..."
            cd ${{ env.DEPLOY_PATH }}

            # Map backup types (workflow uses config-only/database-only, CLI uses config/database)
            BACKUP_TYPE="${{ inputs.backup_type || 'full' }}"
            case "$BACKUP_TYPE" in
              "config-only")
                BACKUP_TYPE="config"
                ;;
              "database-only")
                BACKUP_TYPE="database"
                ;;
            esac

            # Run backup using homelab_tools (backs up entire /opt/homelab folder)
            export BORG_PASSPHRASE="${{ secrets.BORG_PASSPHRASE }}"
            python3 -m homelab_tools backup create --type "$BACKUP_TYPE" --repository primary

            echo "âœ… Backup completed successfully!"
            
            # Get backup info for display
            BACKUP_INFO=$(python3 -m homelab_tools backup list --repository primary | tail -1 || echo "N/A")
            echo "ðŸ“¦ Latest backup: $BACKUP_INFO"
          EOF

      - name: Verify backup integrity
        env:
          BORG_PASSPHRASE: ${{ secrets.BORG_PASSPHRASE }}
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            set -e
            echo "ðŸ” Verifying backup integrity..."
            cd ${{ env.DEPLOY_PATH }}

            # Verify repository integrity using homelab_tools
            export BORG_PASSPHRASE="${{ secrets.BORG_PASSPHRASE }}"
            if python3 -m homelab_tools backup verify --repository primary; then
              echo "âœ… Backup repository integrity verified!"
            else
              echo "âŒ Backup repository verification failed!"
              exit 1
            fi

            # Verify backups exist
            BACKUP_COUNT=$(python3 -m homelab_tools backup list --repository primary | wc -l)
            if [ "$BACKUP_COUNT" -eq 0 ]; then
              echo "âŒ No backups found in repository!"
              exit 1
            fi

            echo "âœ… Found $BACKUP_COUNT backup(s) in repository"
          EOF

      - name: Prune old backups
        env:
          BORG_PASSPHRASE: ${{ secrets.BORG_PASSPHRASE }}
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            set -e
            echo "ðŸ§¹ Pruning old backups..."
            cd ${{ env.DEPLOY_PATH }}

            # Prune old backups using homelab_tools (keeps 14 daily, 12 weekly, 24 monthly)
            export BORG_PASSPHRASE="${{ secrets.BORG_PASSPHRASE }}"
            python3 -m homelab_tools backup prune --repository primary --keep-daily 14 --keep-weekly 12 --keep-monthly 24

            echo "âœ… Backup pruning completed!"
          EOF

      - name: Notify success
        if: success()
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=âœ… Backup Successful" \
            -F "message=Daily backup completed successfully using homelab_tools (BorgBackup)" \
            -F "priority=5"

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=âŒ Backup Failed" \
            -F "message=Daily backup failed. Immediate attention required!" \
            -F "priority=10"

  ##############################################################################
  # BACKUP REPORT
  ##############################################################################
  backup-report:
    name: Generate Backup Report
    runs-on: ubuntu-latest
    needs: backup
    if: success()
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Generate report
        env:
          BORG_PASSPHRASE: ${{ secrets.BORG_PASSPHRASE }}
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            set -e
            echo "ðŸ“Š Generating backup report..."
            cd ${{ env.DEPLOY_PATH }}

            export BORG_PASSPHRASE="${{ secrets.BORG_PASSPHRASE }}"

            # List all backups
            BACKUP_LIST=$(python3 -m homelab_tools backup list --repository primary)
            TOTAL_BACKUPS=$(echo "$BACKUP_LIST" | wc -l)

            # Get latest backup
            LATEST_BACKUP=$(echo "$BACKUP_LIST" | head -1)

            # Get oldest backup
            OLDEST_BACKUP=$(echo "$BACKUP_LIST" | tail -1)

            echo "ðŸ“Š Backup Statistics (Borg Repository):"
            echo "  Total backups: $TOTAL_BACKUPS"
            echo "  Latest backup: $LATEST_BACKUP"
            echo "  Oldest backup: $OLDEST_BACKUP"
            echo ""
            echo "Backup List:"
            echo "$BACKUP_LIST"
          EOF
