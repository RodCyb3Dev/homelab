##############################################################################
# GITHUB ACTIONS - Update README Statistics
# Automatically generates and updates project statistics in README.md
##############################################################################

name: Update README Statistics

on:
  schedule:
    # Daily at 00:00 UTC
    - cron: '0 0 * * *'

  workflow_dispatch:

  push:
    branches:
      - main
    paths:
      - '**.py'
      - '**.yml'
      - '**.yaml'
      - '**.sh'
      - '**.md'
      - 'docker-compose*.yml'
      - 'README.md'

permissions:
  contents: write
  pages: write

jobs:
  ##############################################################################
  # GENERATE STATISTICS
  ##############################################################################
  generate-stats:
    name: Generate Project Statistics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate statistics
        id: stats
        run: |
          echo "üìä Generating project statistics..."

          # Get commit info
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/$COMMIT_SHA"
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Count files by type
          TOTAL_FILES=$(find . -type f -not -path "./.git/*" -not -path "./.github/*" -not -path "./node_modules/*" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./__pycache__/*" -not -path "./*.egg-info/*" | wc -l | tr -d ' ')

          # Python files
          PYTHON_FILES=$(find . -name "*.py" -not -path "./.git/*" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./__pycache__/*" | wc -l | tr -d ' ')
          PYTHON_LINES=$(find . -name "*.py" -not -path "./.git/*" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./__pycache__/*" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")

          # YAML files
          YAML_FILES=$(find . -name "*.yml" -o -name "*.yaml" -not -path "./.git/*" -not -path "./.venv/*" -not -path "./venv/*" | wc -l | tr -d ' ')
          YAML_LINES=$(find . \( -name "*.yml" -o -name "*.yaml" \) -not -path "./.git/*" -not -path "./.venv/*" -not -path "./venv/*" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")

          # Shell scripts
          SHELL_FILES=$(find . -name "*.sh" -not -path "./.git/*" | wc -l | tr -d ' ')
          SHELL_LINES=$(find . -name "*.sh" -not -path "./.git/*" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")

          # Markdown files
          MD_FILES=$(find . -name "*.md" -not -path "./.git/*" -not -path "./.wiki/*" | wc -l | tr -d ' ')
          MD_LINES=$(find . -name "*.md" -not -path "./.git/*" -not -path "./.wiki/*" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")

          # Docker Compose files
          COMPOSE_FILES=$(find . -name "docker-compose*.yml" -not -path "./.git/*" | wc -l | tr -d ' ')

          # Ansible files
          ANSIBLE_FILES=$(find ./ansible -type f \( -name "*.yml" -o -name "*.yaml" \) -not -path "./.git/*" 2>/dev/null | wc -l | tr -d ' ')

          # Config files
          CONFIG_DIRS=$(find ./config -type d -not -path "./.git/*" 2>/dev/null | wc -l | tr -d ' ')

          # Total code lines (approximate)
          TOTAL_LINES=$(find . -type f \( -name "*.py" -o -name "*.yml" -o -name "*.yaml" -o -name "*.sh" -o -name "*.md" \) -not -path "./.git/*" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./__pycache__/*" -not -path "./.wiki/*" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")

          # Services count (from docker-compose files)
          SERVICES=$(docker-compose config --services 2>/dev/null | wc -l | tr -d ' ' || echo "0")

          # Output to GitHub Actions
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_url=$COMMIT_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "python_files=$PYTHON_FILES" >> $GITHUB_OUTPUT
          echo "python_lines=$PYTHON_LINES" >> $GITHUB_OUTPUT
          echo "yaml_files=$YAML_FILES" >> $GITHUB_OUTPUT
          echo "yaml_lines=$YAML_LINES" >> $GITHUB_OUTPUT
          echo "shell_files=$SHELL_FILES" >> $GITHUB_OUTPUT
          echo "shell_lines=$SHELL_LINES" >> $GITHUB_OUTPUT
          echo "md_files=$MD_FILES" >> $GITHUB_OUTPUT
          echo "md_lines=$MD_LINES" >> $GITHUB_OUTPUT
          echo "compose_files=$COMPOSE_FILES" >> $GITHUB_OUTPUT
          echo "ansible_files=$ANSIBLE_FILES" >> $GITHUB_OUTPUT
          echo "config_dirs=$CONFIG_DIRS" >> $GITHUB_OUTPUT
          echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
          echo "services=$SERVICES" >> $GITHUB_OUTPUT

          echo "‚úÖ Statistics generated:"
          echo "  Total Files: $TOTAL_FILES"
          echo "  Python: $PYTHON_FILES files, $PYTHON_LINES lines"
          echo "  YAML: $YAML_FILES files, $YAML_LINES lines"
          echo "  Shell: $SHELL_FILES files, $SHELL_LINES lines"
          echo "  Markdown: $MD_FILES files, $MD_LINES lines"
          echo "  Docker Services: $SERVICES"

      - name: Update README.md with statistics
        run: |
          echo "üìù Updating README.md with statistics..."
          
          # Check if README.md exists
          if [ ! -f README.md ]; then
            echo "‚ùå README.md not found!"
            exit 1
          fi
          
          # Use Python to replace the stats section
          python3 << 'PYTHON_EOF'
          import re
          import os
          
          # Read README
          with open('README.md', 'r') as f:
              content = f.read()
          
          # Get values from environment (set by GitHub Actions)
          timestamp = os.environ.get('TIMESTAMP', '')
          commit_sha = os.environ.get('COMMIT_SHA', '')
          commit_url = os.environ.get('COMMIT_URL', '')
          branch = os.environ.get('BRANCH', '')
          total_files = os.environ.get('TOTAL_FILES', '0')
          total_lines = os.environ.get('TOTAL_LINES', '0')
          python_files = os.environ.get('PYTHON_FILES', '0')
          python_lines = os.environ.get('PYTHON_LINES', '0')
          yaml_files = os.environ.get('YAML_FILES', '0')
          yaml_lines = os.environ.get('YAML_LINES', '0')
          shell_files = os.environ.get('SHELL_FILES', '0')
          shell_lines = os.environ.get('SHELL_LINES', '0')
          md_files = os.environ.get('MD_FILES', '0')
          services = os.environ.get('SERVICES', '0')
          compose_files = os.environ.get('COMPOSE_FILES', '0')
          ansible_files = os.environ.get('ANSIBLE_FILES', '0')
          config_dirs = os.environ.get('CONFIG_DIRS', '0')
          
          # Build stats section (using list join to avoid triple quote issues in YAML)
          stats_lines = [
              "<!-- AUTO-GENERATED STATS - DO NOT EDIT MANUALLY -->",
              "<!-- STATS_START -->",
              "",
              f"**Last Updated**: {timestamp} | **Commit**: [{commit_sha}]({commit_url}) | **Branch**: {branch}",
              "",
              "## üìä Quick Statistics",
              "",
              "| **Metric**        | **Count** | **Details**                                              |",
              "| ----------------- | --------- | ------------------------------------------------------------- |",
              f"| **Total Files**   | {total_files}       | [üìà Full Analysis](../../wiki/Project-Statistics)             |",
              f"| **Code Lines**    | {total_lines}+   | [üèóÔ∏è Architecture Overview](../../wiki/Architecture-Overview) |",
              f"| **Python**        | {python_files} files | {python_lines} lines                                                  |",
              f"| **YAML**          | {yaml_files} files  | {yaml_lines} lines                                                   |",
              f"| **Shell Scripts** | {shell_files} files | {shell_lines} lines                                                  |",
              f"| **Documentation** | {md_files} files  | [üìö Documentation Index](../../wiki/Documentation-Index)      |",
              f"| **Docker Services** | {services} services | {compose_files} compose files |",
              "",
              "### üöÄ Key Components",
              "",
              "| **Component**        | **Files** | **Purpose**         |",
              "| -------------------- | --------- | ------------------- |",
              f"| **Python Tools**     | {python_files}       | CLI & automation     |",
              f"| **Ansible Playbooks** | {ansible_files}       | Infrastructure as code   |",
              f"| **Config Directories**   | {config_dirs}        | Service configurations |",
              "",
              "---",
              "",
              "üìö **[View Complete Analytics in Wiki ‚Üí](../../wiki/Home)**  ",
              "üîç **[Detailed Statistics ‚Üí](../../wiki/Project-Statistics)**  ",
              "üèóÔ∏è **[Architecture Overview ‚Üí](../../wiki/Architecture-Overview)**",
              "",
              "<!-- STATS_END -->"
          ]
          stats_section = "\n".join(stats_lines)
          
          # Replace stats section if it exists
          pattern = r'<!-- STATS_START -->.*?<!-- STATS_END -->'
          
          if re.search(pattern, content, re.DOTALL):
              # Replace existing section
              new_content = re.sub(pattern, stats_section.strip(), content, flags=re.DOTALL)
              print("‚úÖ Updated existing stats section in README.md")
          else:
              # Find insertion point (after Features section, before Table of Contents)
              toc_pattern = r'(## üìã Table of Contents)'
              if re.search(toc_pattern, content):
                  new_content = re.sub(
                      toc_pattern,
                      stats_section.strip() + '\n\n' + r'\1',
                      content
                  )
                  print("‚úÖ Added new stats section before Table of Contents")
              else:
                  # Append at the end
                  new_content = content + '\n\n' + stats_section.strip()
                  print("‚úÖ Added new stats section at the end")
          
          # Write updated README
          with open('README.md', 'w') as f:
              f.write(new_content)
          PYTHON_EOF
        env:
          TIMESTAMP: ${{ steps.stats.outputs.timestamp }}
          COMMIT_SHA: ${{ steps.stats.outputs.commit_sha }}
          COMMIT_URL: ${{ steps.stats.outputs.commit_url }}
          BRANCH: ${{ steps.stats.outputs.branch }}
          TOTAL_FILES: ${{ steps.stats.outputs.total_files }}
          TOTAL_LINES: ${{ steps.stats.outputs.total_lines }}
          PYTHON_FILES: ${{ steps.stats.outputs.python_files }}
          PYTHON_LINES: ${{ steps.stats.outputs.python_lines }}
          YAML_FILES: ${{ steps.stats.outputs.yaml_files }}
          YAML_LINES: ${{ steps.stats.outputs.yaml_lines }}
          SHELL_FILES: ${{ steps.stats.outputs.shell_files }}
          SHELL_LINES: ${{ steps.stats.outputs.shell_lines }}
          MD_FILES: ${{ steps.stats.outputs.md_files }}
          SERVICES: ${{ steps.stats.outputs.services }}
          COMPOSE_FILES: ${{ steps.stats.outputs.compose_files }}
          ANSIBLE_FILES: ${{ steps.stats.outputs.ansible_files }}
          CONFIG_DIRS: ${{ steps.stats.outputs.config_dirs }}

      - name: Generate Wiki Pages
        run: |
          echo "üìö Generating wiki pages..."

mkdir -p .wiki

# Generate Home.md (use EOF without quotes to allow GitHub Actions variable expansion)
cat > .wiki/Home.md << EOF
# Homelab Infrastructure Wiki

Welcome to the Homelab Infrastructure documentation wiki!

## üìã Quick Links

- [Project Statistics](./Project-Statistics) - Comprehensive project analytics
- [Architecture Overview](./Architecture-Overview) - System architecture and design
- [Documentation Index](./Documentation-Index) - All documentation files

## üèóÔ∏è Infrastructure Overview

This homelab infrastructure includes:

- **Media Services**: Jellyfin, Jellyseerr, Arr stack (Radarr, Sonarr, Prowlarr, Lidarr, LazyLibrarian)
- **Audio Services**: Audiobookshelf, Navidrome
- **Photo Management**: Immich
- **Security**: Authelia, CrowdSec, Fail2ban
- **Monitoring**: Prometheus, Grafana, Loki, Uptime Kuma
- **Automation**: Ansible playbooks, Python CLI tools

## üìä Current Statistics

See the [Project Statistics](./Project-Statistics) page for detailed analytics.

## üîß Tools & Technologies

- **Containerization**: Docker & Docker Compose
- **Orchestration**: Ansible
- **Reverse Proxy**: Caddy
- **VPN**: Tailscale
- **Backup**: BorgBackup
- **Monitoring**: Prometheus, Grafana, Loki

---

*Last updated: ${{ steps.stats.outputs.timestamp }}*
EOF

# Generate Project-Statistics.md
cat > .wiki/Project-Statistics.md << EOF
# Project Statistics

Comprehensive analytics and statistics for the Homelab Infrastructure project.

*Last Updated: ${{ steps.stats.outputs.timestamp }}*  
*Commit: [${{ steps.stats.outputs.commit_sha }}](${{ steps.stats.outputs.commit_url }})*  
*Branch: ${{ steps.stats.outputs.branch }}*

## üìä File Statistics

| **Type** | **Files** | **Lines** |
|----------|-----------|-----------|
| **Total Files** | ${{ steps.stats.outputs.total_files }} | - |
| **Python** | ${{ steps.stats.outputs.python_files }} | ${{ steps.stats.outputs.python_lines }} |
| **YAML** | ${{ steps.stats.outputs.yaml_files }} | ${{ steps.stats.outputs.yaml_lines }} |
| **Shell Scripts** | ${{ steps.stats.outputs.shell_files }} | ${{ steps.stats.outputs.shell_lines }} |
| **Markdown** | ${{ steps.stats.outputs.md_files }} | ${{ steps.stats.outputs.md_lines }} |
| **Total Code Lines** | - | ${{ steps.stats.outputs.total_lines }}+ |

## üê≥ Docker Infrastructure

| **Metric** | **Count** |
|------------|-----------|
| **Docker Services** | ${{ steps.stats.outputs.services }} |
| **Docker Compose Files** | ${{ steps.stats.outputs.compose_files }} |

## üîß Infrastructure Components

| **Component** | **Count** |
|---------------|-----------|
| **Ansible Playbooks** | ${{ steps.stats.outputs.ansible_files }} |
| **Config Directories** | ${{ steps.stats.outputs.config_dirs }} |

## üìà Growth Trends

Statistics are automatically updated daily via GitHub Actions.

## üîç Analysis Tools

- **Code Analysis**: GitHub Actions workflows
- **Security Scanning**: Trivy, Docker Scout
- **Quality Checks**: Prettier, ShellCheck, YAML Lint

---

[‚Üê Back to Home](./Home)
EOF

echo "‚úÖ Wiki pages generated in .wiki/ directory"

- name: Commit and push changes
run: |
git config --local user.email "github-actions[bot]@users.noreply.github.com"
git config --local user.name "github-actions[bot]"

git add README.md .wiki/

if git diff --staged --quiet; then
  echo "No changes to commit"
else
  git commit -m "üìä Auto-update project statistics [skip ci]"
  git push
  echo "‚úÖ Statistics updated and pushed"
fi
