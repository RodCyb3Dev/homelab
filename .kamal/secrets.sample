#!/bin/bash
# Secrets defined here are available for reference under registry/password, env/secret,
# builder/secrets, and accessories/*/env/secret in config/deploy.yml.
# All secrets should be pulled from either password manager, ENV, or a file.
# DO NOT ENTER RAW CREDENTIALS HERE! This file needs to be safe for git.

# Example of extracting secrets from 1password (or another compatible pw manager)
# Fetch all secrets from 1Password in one command
kamal secrets fetch --adapter 1password --account 5TIAZZBTW5AOJC3I5TEBUQNYMQ --from homelab-env \
  DOMAIN \
  CF_API_EMAIL \
  CF_API_KEY \
  TS_AUTHKEY \
  AUTHELIA_JWT_SECRET \
  AUTHELIA_SESSION_SECRET \
  AUTHELIA_STORAGE_ENCRYPTION_KEY \
  AUTHELIA_NOTIFIER_SMTP_PASSWORD \
  CROWDSEC_BOUNCER_KEY \
  CROWDSEC_ENROLL_KEY \
  GRAFANA_ADMIN_USER \
  GRAFANA_ADMIN_PASSWORD \
  POSTGRES_PASSWORD \
  AUTHELIA_STORAGE_POSTGRES_PASSWORD \
  REDIS_PASSWORD \
  STORAGE_BOX_HOST \
  STORAGE_BOX_USER \
  STORAGE_BOX_PASSWORD \
  BACKUP_ENCRYPTION_KEY \
  PUID \
  PGID \
  TIMEZONE \
  KAMAL_REGISTRY_USERNAME \
  KAMAL_REGISTRY_PASSWORD \
  > /tmp/kamal_secrets.$$ 2>/dev/null

# Check if fetch was successful
SECRETS=""
if [ -f /tmp/kamal_secrets.$$ ] && [ -s /tmp/kamal_secrets.$$ ]; then
  if ! grep -qi "ERROR\|Failed" /tmp/kamal_secrets.$$ 2>/dev/null; then
    SECRETS=$(cat /tmp/kamal_secrets.$$ 2>/dev/null)
  fi
  rm -f /tmp/kamal_secrets.$$
fi

# Extract secrets if we have them (only if SECRETS is non-empty and has content)
if [ -n "$SECRETS" ] && [ ${#SECRETS} -gt 10 ]; then
  # Extract individual secrets using Kamal's extract command
  # Note: Redirect stderr to /dev/null to suppress errors if secret not found
  DOMAIN=$(kamal secrets extract DOMAIN "${SECRETS}" 2>&1 | grep -v "ERROR\|Usage" || echo "")
  [ -z "$DOMAIN" ] && DOMAIN=""
  CF_API_EMAIL=$(kamal secrets extract CF_API_EMAIL "${SECRETS}" 2>&1 | grep -v "ERROR\|Usage" || echo "")
  [ -z "$CF_API_EMAIL" ] && CF_API_EMAIL=""
  CF_API_KEY=$(kamal secrets extract CF_API_KEY "${SECRETS}" 2>/dev/null)
  [ -z "$CF_API_KEY" ] && CF_API_KEY=""
  TS_AUTHKEY=$(kamal secrets extract TS_AUTHKEY "${SECRETS}" 2>/dev/null)
  [ -z "$TS_AUTHKEY" ] && TS_AUTHKEY=""
  AUTHELIA_JWT_SECRET=$(kamal secrets extract AUTHELIA_JWT_SECRET "${SECRETS}" 2>/dev/null)
  [ -z "$AUTHELIA_JWT_SECRET" ] && AUTHELIA_JWT_SECRET=""
  AUTHELIA_SESSION_SECRET=$(kamal secrets extract AUTHELIA_SESSION_SECRET "${SECRETS}" 2>/dev/null)
  [ -z "$AUTHELIA_SESSION_SECRET" ] && AUTHELIA_SESSION_SECRET=""
  AUTHELIA_STORAGE_ENCRYPTION_KEY=$(kamal secrets extract AUTHELIA_STORAGE_ENCRYPTION_KEY "${SECRETS}" 2>/dev/null)
  [ -z "$AUTHELIA_STORAGE_ENCRYPTION_KEY" ] && AUTHELIA_STORAGE_ENCRYPTION_KEY=""
  AUTHELIA_NOTIFIER_SMTP_PASSWORD=$(kamal secrets extract AUTHELIA_NOTIFIER_SMTP_PASSWORD "${SECRETS}" 2>/dev/null)
  [ -z "$AUTHELIA_NOTIFIER_SMTP_PASSWORD" ] && AUTHELIA_NOTIFIER_SMTP_PASSWORD=""
  CROWDSEC_BOUNCER_KEY=$(kamal secrets extract CROWDSEC_BOUNCER_KEY "${SECRETS}" 2>/dev/null)
  [ -z "$CROWDSEC_BOUNCER_KEY" ] && CROWDSEC_BOUNCER_KEY=""
  CROWDSEC_ENROLL_KEY=$(kamal secrets extract CROWDSEC_ENROLL_KEY "${SECRETS}" 2>/dev/null)
  [ -z "$CROWDSEC_ENROLL_KEY" ] && CROWDSEC_ENROLL_KEY=""
  GRAFANA_ADMIN_USER=$(kamal secrets extract GRAFANA_ADMIN_USER "${SECRETS}" 2>/dev/null)
  [ -z "$GRAFANA_ADMIN_USER" ] && GRAFANA_ADMIN_USER=""
  GRAFANA_ADMIN_PASSWORD=$(kamal secrets extract GRAFANA_ADMIN_PASSWORD "${SECRETS}" 2>/dev/null)
  [ -z "$GRAFANA_ADMIN_PASSWORD" ] && GRAFANA_ADMIN_PASSWORD=""
  POSTGRES_PASSWORD=$(kamal secrets extract POSTGRES_PASSWORD "${SECRETS}" 2>/dev/null)
  [ -z "$POSTGRES_PASSWORD" ] && POSTGRES_PASSWORD=""
  AUTHELIA_STORAGE_POSTGRES_PASSWORD=$(kamal secrets extract AUTHELIA_STORAGE_POSTGRES_PASSWORD "${SECRETS}" 2>/dev/null)
  [ -z "$AUTHELIA_STORAGE_POSTGRES_PASSWORD" ] && AUTHELIA_STORAGE_POSTGRES_PASSWORD=""
  REDIS_PASSWORD=$(kamal secrets extract REDIS_PASSWORD "${SECRETS}" 2>/dev/null)
  [ -z "$REDIS_PASSWORD" ] && REDIS_PASSWORD=""
  STORAGE_BOX_HOST=$(kamal secrets extract STORAGE_BOX_HOST "${SECRETS}" 2>/dev/null)
  [ -z "$STORAGE_BOX_HOST" ] && STORAGE_BOX_HOST=""
  STORAGE_BOX_USER=$(kamal secrets extract STORAGE_BOX_USER "${SECRETS}" 2>/dev/null)
  [ -z "$STORAGE_BOX_USER" ] && STORAGE_BOX_USER=""
  STORAGE_BOX_PASSWORD=$(kamal secrets extract STORAGE_BOX_PASSWORD "${SECRETS}" 2>/dev/null)
  [ -z "$STORAGE_BOX_PASSWORD" ] && STORAGE_BOX_PASSWORD=""
  BACKUP_ENCRYPTION_KEY=$(kamal secrets extract BACKUP_ENCRYPTION_KEY "${SECRETS}" 2>/dev/null)
  [ -z "$BACKUP_ENCRYPTION_KEY" ] && BACKUP_ENCRYPTION_KEY=""
  PUID=$(kamal secrets extract PUID "${SECRETS}" 2>/dev/null)
  [ -z "$PUID" ] && PUID="1000"
  PGID=$(kamal secrets extract PGID "${SECRETS}" 2>/dev/null)
  [ -z "$PGID" ] && PGID="1000"
  TIMEZONE=$(kamal secrets extract TIMEZONE "${SECRETS}" 2>/dev/null)
  [ -z "$TIMEZONE" ] && TIMEZONE="UTC"
  KAMAL_REGISTRY_USERNAME=$(kamal secrets extract KAMAL_REGISTRY_USERNAME "${SECRETS}" 2>/dev/null)
  [ -z "$KAMAL_REGISTRY_USERNAME" ] && KAMAL_REGISTRY_USERNAME=""
  KAMAL_REGISTRY_PASSWORD=$(kamal secrets extract KAMAL_REGISTRY_PASSWORD "${SECRETS}" 2>/dev/null || echo "")
  [ -z "$KAMAL_REGISTRY_PASSWORD" ] && KAMAL_REGISTRY_PASSWORD=""
else
  # SECRETS was empty or fetch failed, initialize all to empty
  DOMAIN=""
  CF_API_EMAIL=""
  CF_API_KEY=""
  TS_AUTHKEY=""
  AUTHELIA_JWT_SECRET=""
  AUTHELIA_SESSION_SECRET=""
  AUTHELIA_STORAGE_ENCRYPTION_KEY=""
  AUTHELIA_NOTIFIER_SMTP_PASSWORD=""
  CROWDSEC_BOUNCER_KEY=""
  CROWDSEC_ENROLL_KEY=""
  GRAFANA_ADMIN_USER=""
  GRAFANA_ADMIN_PASSWORD=""
  POSTGRES_PASSWORD=""
  AUTHELIA_STORAGE_POSTGRES_PASSWORD=""
  REDIS_PASSWORD=""
  STORAGE_BOX_HOST=""
  STORAGE_BOX_USER=""
  STORAGE_BOX_PASSWORD=""
  BACKUP_ENCRYPTION_KEY=""
  PUID="1000"
  PGID="1000"
  TIMEZONE="UTC"
  KAMAL_REGISTRY_USERNAME=""
  KAMAL_REGISTRY_PASSWORD=""
fi

# Fallback to environment variables or .env file if secrets are still empty
ENV_FILE="${KAMAL_SECRETS_ENV_FILE:-.env}"

# Try environment variables first
[ -z "$DOMAIN" ] && DOMAIN="${DOMAIN:-}"
[ -z "$CF_API_EMAIL" ] && CF_API_EMAIL="${CF_API_EMAIL:-}"
[ -z "$CF_API_KEY" ] && CF_API_KEY="${CF_API_KEY:-}"
[ -z "$TS_AUTHKEY" ] && TS_AUTHKEY="${TS_AUTHKEY:-}"
[ -z "$AUTHELIA_JWT_SECRET" ] && AUTHELIA_JWT_SECRET="${AUTHELIA_JWT_SECRET:-}"
[ -z "$AUTHELIA_SESSION_SECRET" ] && AUTHELIA_SESSION_SECRET="${AUTHELIA_SESSION_SECRET:-}"
[ -z "$AUTHELIA_STORAGE_ENCRYPTION_KEY" ] && AUTHELIA_STORAGE_ENCRYPTION_KEY="${AUTHELIA_STORAGE_ENCRYPTION_KEY:-}"
[ -z "$AUTHELIA_NOTIFIER_SMTP_PASSWORD" ] && AUTHELIA_NOTIFIER_SMTP_PASSWORD="${AUTHELIA_NOTIFIER_SMTP_PASSWORD:-}"
[ -z "$CROWDSEC_BOUNCER_KEY" ] && CROWDSEC_BOUNCER_KEY="${CROWDSEC_BOUNCER_KEY:-}"
[ -z "$CROWDSEC_ENROLL_KEY" ] && CROWDSEC_ENROLL_KEY="${CROWDSEC_ENROLL_KEY:-}"
[ -z "$GRAFANA_ADMIN_USER" ] && GRAFANA_ADMIN_USER="${GRAFANA_ADMIN_USER:-}"
[ -z "$GRAFANA_ADMIN_PASSWORD" ] && GRAFANA_ADMIN_PASSWORD="${GRAFANA_ADMIN_PASSWORD:-}"
[ -z "$POSTGRES_PASSWORD" ] && POSTGRES_PASSWORD="${POSTGRES_PASSWORD:-}"
[ -z "$AUTHELIA_STORAGE_POSTGRES_PASSWORD" ] && AUTHELIA_STORAGE_POSTGRES_PASSWORD="${AUTHELIA_STORAGE_POSTGRES_PASSWORD:-}"
[ -z "$REDIS_PASSWORD" ] && REDIS_PASSWORD="${REDIS_PASSWORD:-}"
[ -z "$STORAGE_BOX_HOST" ] && STORAGE_BOX_HOST="${STORAGE_BOX_HOST:-}"
[ -z "$STORAGE_BOX_USER" ] && STORAGE_BOX_USER="${STORAGE_BOX_USER:-}"
[ -z "$STORAGE_BOX_PASSWORD" ] && STORAGE_BOX_PASSWORD="${STORAGE_BOX_PASSWORD:-}"
[ -z "$BACKUP_ENCRYPTION_KEY" ] && BACKUP_ENCRYPTION_KEY="${BACKUP_ENCRYPTION_KEY:-}"
[ -z "$PUID" ] && PUID="${PUID:-1000}"
[ -z "$PGID" ] && PGID="${PGID:-1000}"
[ -z "$TIMEZONE" ] && TIMEZONE="${TIMEZONE:-UTC}"
[ -z "$KAMAL_REGISTRY_USERNAME" ] && KAMAL_REGISTRY_USERNAME="${KAMAL_REGISTRY_USERNAME:-}"
[ -z "$KAMAL_REGISTRY_PASSWORD" ] && KAMAL_REGISTRY_PASSWORD="${KAMAL_REGISTRY_PASSWORD:-}"

# Fallback to .env file
if [ -f "$ENV_FILE" ]; then
  [ -z "$DOMAIN" ] && DOMAIN=$(grep "^DOMAIN=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$CF_API_EMAIL" ] && CF_API_EMAIL=$(grep "^CF_API_EMAIL=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$CF_API_KEY" ] && CF_API_KEY=$(grep "^CF_API_KEY=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$TS_AUTHKEY" ] && TS_AUTHKEY=$(grep "^TS_AUTHKEY=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$AUTHELIA_JWT_SECRET" ] && AUTHELIA_JWT_SECRET=$(grep "^AUTHELIA_JWT_SECRET=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$AUTHELIA_SESSION_SECRET" ] && AUTHELIA_SESSION_SECRET=$(grep "^AUTHELIA_SESSION_SECRET=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$AUTHELIA_STORAGE_ENCRYPTION_KEY" ] && AUTHELIA_STORAGE_ENCRYPTION_KEY=$(grep "^AUTHELIA_STORAGE_ENCRYPTION_KEY=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$AUTHELIA_NOTIFIER_SMTP_PASSWORD" ] && AUTHELIA_NOTIFIER_SMTP_PASSWORD=$(grep "^AUTHELIA_NOTIFIER_SMTP_PASSWORD=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$CROWDSEC_BOUNCER_KEY" ] && CROWDSEC_BOUNCER_KEY=$(grep "^CROWDSEC_BOUNCER_KEY=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$CROWDSEC_ENROLL_KEY" ] && CROWDSEC_ENROLL_KEY=$(grep "^CROWDSEC_ENROLL_KEY=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$GRAFANA_ADMIN_USER" ] && GRAFANA_ADMIN_USER=$(grep "^GRAFANA_ADMIN_USER=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$GRAFANA_ADMIN_PASSWORD" ] && GRAFANA_ADMIN_PASSWORD=$(grep "^GRAFANA_ADMIN_PASSWORD=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$POSTGRES_PASSWORD" ] && POSTGRES_PASSWORD=$(grep "^POSTGRES_PASSWORD=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$AUTHELIA_STORAGE_POSTGRES_PASSWORD" ] && AUTHELIA_STORAGE_POSTGRES_PASSWORD=$(grep "^AUTHELIA_STORAGE_POSTGRES_PASSWORD=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$REDIS_PASSWORD" ] && REDIS_PASSWORD=$(grep "^REDIS_PASSWORD=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$STORAGE_BOX_HOST" ] && STORAGE_BOX_HOST=$(grep "^STORAGE_BOX_HOST=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$STORAGE_BOX_USER" ] && STORAGE_BOX_USER=$(grep "^STORAGE_BOX_USER=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$STORAGE_BOX_PASSWORD" ] && STORAGE_BOX_PASSWORD=$(grep "^STORAGE_BOX_PASSWORD=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$BACKUP_ENCRYPTION_KEY" ] && BACKUP_ENCRYPTION_KEY=$(grep "^BACKUP_ENCRYPTION_KEY=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$PUID" ] && PUID=$(grep "^PUID=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "1000")
  [ -z "$PGID" ] && PGID=$(grep "^PGID=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "1000")
  [ -z "$TIMEZONE" ] && TIMEZONE=$(grep "^TIMEZONE=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "UTC")
  [ -z "$KAMAL_REGISTRY_USERNAME" ] && KAMAL_REGISTRY_USERNAME=$(grep "^KAMAL_REGISTRY_USERNAME=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
  [ -z "$KAMAL_REGISTRY_PASSWORD" ] && KAMAL_REGISTRY_PASSWORD=$(grep "^KAMAL_REGISTRY_PASSWORD=" "$ENV_FILE" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo "")
fi

# Output all secrets in KEY=VALUE format for Kamal
# Use printf to avoid quote issues with special characters
printf "DOMAIN=%s\n" "${DOMAIN}"
printf "CF_API_EMAIL=%s\n" "${CF_API_EMAIL}"
printf "CF_API_KEY=%s\n" "${CF_API_KEY}"
printf "TS_AUTHKEY=%s\n" "${TS_AUTHKEY}"
printf "AUTHELIA_JWT_SECRET=%s\n" "${AUTHELIA_JWT_SECRET}"
printf "AUTHELIA_SESSION_SECRET=%s\n" "${AUTHELIA_SESSION_SECRET}"
printf "AUTHELIA_STORAGE_ENCRYPTION_KEY=%s\n" "${AUTHELIA_STORAGE_ENCRYPTION_KEY}"
printf "AUTHELIA_NOTIFIER_SMTP_PASSWORD=%s\n" "${AUTHELIA_NOTIFIER_SMTP_PASSWORD}"
printf "CROWDSEC_BOUNCER_KEY=%s\n" "${CROWDSEC_BOUNCER_KEY}"
printf "CROWDSEC_ENROLL_KEY=%s\n" "${CROWDSEC_ENROLL_KEY}"
printf "GRAFANA_ADMIN_USER=%s\n" "${GRAFANA_ADMIN_USER}"
printf "GRAFANA_ADMIN_PASSWORD=%s\n" "${GRAFANA_ADMIN_PASSWORD}"
printf "POSTGRES_PASSWORD=%s\n" "${POSTGRES_PASSWORD}"
printf "AUTHELIA_STORAGE_POSTGRES_PASSWORD=%s\n" "${AUTHELIA_STORAGE_POSTGRES_PASSWORD}"
printf "REDIS_PASSWORD=%s\n" "${REDIS_PASSWORD}"
printf "STORAGE_BOX_HOST=%s\n" "${STORAGE_BOX_HOST}"
printf "STORAGE_BOX_USER=%s\n" "${STORAGE_BOX_USER}"
printf "STORAGE_BOX_PASSWORD=%s\n" "${STORAGE_BOX_PASSWORD}"
printf "BACKUP_ENCRYPTION_KEY=%s\n" "${BACKUP_ENCRYPTION_KEY}"
printf "PUID=%s\n" "${PUID}"
printf "PGID=%s\n" "${PGID}"
printf "TIMEZONE=%s\n" "${TIMEZONE}"
printf "KAMAL_REGISTRY_USERNAME=%s\n" "${KAMAL_REGISTRY_USERNAME}"
printf "KAMAL_REGISTRY_PASSWORD=%s\n" "${KAMAL_REGISTRY_PASSWORD}"
