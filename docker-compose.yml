##############################################################################
# CORE INFRASTRUCTURE - Secure Homelab Base
# Security Stack with Caddy Reverse Proxy
##############################################################################
networks:
  caddy-proxy:
    driver: bridge
    name: caddy-proxy
  grafana-monitoring:
    external: true
    name: homelab_grafana-monitoring

secrets:
  cf-token:
    file: ./config/caddy/cf-token
  JWT_SECRET:
    file: ./config/authelia/secrets/JWT_SECRET
  SESSION_SECRET:
    file: ./config/authelia/secrets/SESSION_SECRET
  STORAGE_PASSWORD:
    file: ./config/authelia/secrets/STORAGE_PASSWORD
  STORAGE_ENCRYPTION_KEY:
    file: ./config/authelia/secrets/STORAGE_ENCRYPTION_KEY
  AUTHELIA_SMTP_USERNAME:
    file: ./config/authelia/secrets/AUTHELIA_SMTP_USERNAME
  AUTHELIA_NOTIFIER_SMTP_PASSWORD:
    file: ./config/authelia/secrets/AUTHELIA_NOTIFIER_SMTP_PASSWORD

volumes:
  authelia-postgres-data:
  caddy-data:
  caddy-config:

services:
  ##############################################################################
  # SECURITY LAYER - Crowdsec
  ##############################################################################

  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    command: -t
    ports:
      - 6060:6060
    expose:
      - 6060
    environment:
      COLLECTIONS: crowdsecurity/caddy crowdsecurity/appsec-virtual-patching crowdsecurity/appsec-generic-rules
      ENROLL_INSTANCE_NAME: homelab-crowdsec
      ENROLL_TAGS: docker
      GID: "1000"
      PARSERS: crowdsecurity/whitelists
    volumes:
      - ./config/crowdsec:/etc/crowdsec
      - ./config/crowdsec/db:/var/lib/crowdsec/data
      - ./config/crowdsec_logs/auth.log:/var/log/auth.log:ro
      - ./config/crowdsec_logs/syslog:/var/log/syslog:ro
      - ./config/crowdsec_logs:/var/log
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - caddy-proxy
      - grafana-monitoring
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /var/tmp
    healthcheck:
      test:
        - CMD
        - cscli
        - lapi
        - status
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # REVERSE PROXY - Caddy
  ##############################################################################

  caddy:
    # Using builder image with Cloudflare DNS plugin
    # Alternative: caddy:2.8-builder-alpine (requires building with xcaddy)
    # For now, using standard image with HTTP-01 challenge
    image: caddy:2.8-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    networks:
      - caddy-proxy
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - ./config/caddy/cf-token:/run/secrets/cf-token:ro
      - /var/log/caddy:/var/log/caddy
    environment:
      - CF_DNS_API_TOKEN_FILE=/run/secrets/cf-token
      - TZ=${TZ:-UTC}
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
      - /var/run
    depends_on:
      - authelia
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # SECURITY LAYER - Fail2ban
  ##############################################################################

  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=${TZ:-UTC}
      - F2B_DB_PURGE_AGE=30d
      - F2B_LOG_LEVEL=INFO
    volumes:
      - ./config/fail2ban:/data
      - /var/log:/var/log:ro
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # SECURITY LAYER - Authelia
  ##############################################################################

  authelia:
    image: 'docker.io/authelia/authelia:latest'
    container_name: authelia
    volumes:
      - ./config/authelia:/config
    networks:
      - caddy-proxy
      - grafana-monitoring
    depends_on:
      authelia-postgres:
        condition: service_healthy
    secrets:
      - JWT_SECRET
      - SESSION_SECRET
      - STORAGE_PASSWORD
      - STORAGE_ENCRYPTION_KEY
      - AUTHELIA_SMTP_USERNAME
      - AUTHELIA_NOTIFIER_SMTP_PASSWORD
    env_file:
      - .env
    environment:
      TZ: Europe/Helsinki
      AUTHELIA_LOG_LEVEL: 'info'
    security_opt:
      - no-new-privileges:true
    # Note: Authelia needs to write /app/.healthcheck.env for healthcheck metadata
    # Removed read_only restriction to allow healthcheck file writes
    tmpfs:
      - /tmp
      - /var/tmp
    # Removed user restriction to allow proper initialization
    expose:
      - 9091
      - 9959  # Metrics endpoint for Prometheus
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # SECURITY LAYER - PostgreSQL (for Authelia)
  ##############################################################################

  authelia-postgres:
    image: postgres:16-alpine
    container_name: authelia-postgres
    networks:
      - caddy-proxy
    environment:
      POSTGRES_DB: authelia
      POSTGRES_USER: authelia
      POSTGRES_PASSWORD_FILE: /run/secrets/STORAGE_PASSWORD
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: Europe/Helsinki
    secrets:
      - STORAGE_PASSWORD
    volumes:
      - authelia-postgres-data:/var/lib/postgresql/data
    security_opt:
      - no-new-privileges:true
    # Note: PostgreSQL needs root to read secrets during initialization
    # After initialization, it runs as postgres user (999:999) internally
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U authelia -d authelia"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # SECURITY LAYER - Redis
  ##############################################################################

  redis:
    image: redis:alpine
    container_name: redis
    volumes:
      - ./config/redis:/data
    networks:
      - caddy-proxy
    expose:
      - 6379
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    user: "999:999"
    restart: unless-stopped
    environment:
      - TZ=Europe/Helsinki
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
