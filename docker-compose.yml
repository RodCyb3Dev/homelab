##############################################################################
# SECURE HOMELAB INFRASTRUCTURE
# Maximum Security IaC with Defense-in-Depth
# Architecture: Traefik + CrowdSec + Authelia + Tailscale + Full Observability
##############################################################################

networks:
  # Public-facing services network
  public:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

  # Private services network (Tailscale-only)
  private:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24

  # Monitoring and observability network
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24

  # Security services network
  security:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/24

volumes:
  # Hetzner Storage Box for media (CIFS mount)
  hetzner-media:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/storagebox

  # Prometheus time-series database
  prometheus-data:

  # Grafana dashboards and data
  grafana-data:

  # Loki log storage
  loki-data:

  # CrowdSec database
  crowdsec-db:

  # Authelia database
  authelia-db:

secrets:
  # Cloudflare API token for DNS-01 challenge
  cf_api_token:
    file: ./config/traefik/cf_api_token.txt

  # Authelia JWT secret
  authelia_jwt_secret:
    file: ./config/authelia/jwt_secret.txt

  # Authelia session secret
  authelia_session_secret:
    file: ./config/authelia/session_secret.txt

  # Authelia storage encryption key
  authelia_storage_encryption_key:
    file: ./config/authelia/storage_encryption_key.txt

services:
  ##############################################################################
  # CORE INFRASTRUCTURE - Reverse Proxy
  ##############################################################################

  traefik:
    image: traefik:v3.3.6
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    secrets:
      - cf_api_token
    env_file:
      - .env
    networks:
      - public
      - security
      - monitoring
    ports:
      - 80:80
      - 443:443
    environment:
      - TZ=${TZ:-UTC}
      - CF_DNS_API_TOKEN_FILE=/run/secrets/cf_api_token
    depends_on:
      - authelia  # Ensure Authelia starts first so middleware is available

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./config/traefik/dynamic:/etc/traefik/dynamic:ro
      - ./config/traefik/acme.json:/acme.json
      - ./config/traefik/logs:/var/log/traefik
      - /etc/localtime:/etc/localtime:ro
    labels:
      - "traefik.enable=true"
      # Dashboard router - HTTP redirect to HTTPS
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.rule=Host(`traefik.rodneyops.com`)"
      - "traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.traefik.middlewares=traefik-https-redirect"
      # Dashboard router - HTTPS
      - "traefik.http.routers.traefik-secure.entrypoints=websecure"
      - "traefik.http.routers.traefik-secure.rule=Host(`traefik.rodneyops.com`)"
      - "traefik.http.routers.traefik-secure.tls=true"
      - "traefik.http.routers.traefik-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.traefik-secure.service=api@internal"
      - "traefik.http.routers.traefik-secure.middlewares=authelia@docker,security-headers@file"
      # Health check
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ##############################################################################
  # SECURITY LAYER - CrowdSec IDS/IPS
  ##############################################################################

  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - security
      - monitoring
    environment:
      - COLLECTIONS=crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/appsec-virtual-patching crowdsecurity/appsec-generic-rules
      - GID=1000
      # CAPI enrollment - set ENROLL_KEY only if you want to enroll with Central API
      # - ENROLL_KEY=${CROWDSEC_ENROLL_KEY}
      # - ENROLL_INSTANCE_NAME=homelab-hetzner
      # - ENROLL_TAGS=docker,hetzner,production
    volumes:
      - ./config/crowdsec:/etc/crowdsec
      - crowdsec-db:/var/lib/crowdsec/data
      - ./config/traefik/logs:/var/log/traefik:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Required for Docker log acquisition
      - /var/log/auth.log:/var/log/auth.log:ro
      - /var/log/syslog:/var/log/syslog:ro
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
    healthcheck:
      test: ["CMD", "cscli", "version"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CrowdSec Traefik Bouncer
  crowdsec-bouncer-traefik:
    image: fbonalair/traefik-crowdsec-bouncer:latest
    container_name: crowdsec-bouncer-traefik
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - security
    environment:
      - CROWDSEC_BOUNCER_API_KEY=${CROWDSEC_BOUNCER_KEY}
      - CROWDSEC_AGENT_HOST=crowdsec:8080
      - GIN_MODE=release
    depends_on:
      - crowdsec
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # SECURITY LAYER - Authelia SSO with 2FA
  ##############################################################################

  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    networks:
      - security
      - public
    env_file:
      - .env
    environment:
      - TZ=${TZ:-UTC}
      # Secrets are loaded via file:// references in configuration.yml
      # No need to set AUTHELIA_*_FILE environment variables
    secrets:
      - authelia_jwt_secret
      - authelia_session_secret
      - authelia_storage_encryption_key
    volumes:
      - ./config/authelia:/config
      - authelia-db:/var/lib/authelia
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`auth.rodneyops.com`)"
      - "traefik.http.routers.authelia.entrypoints=websecure"
      - "traefik.http.routers.authelia.tls.certresolver=cloudflare"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
      # Authelia middleware
      - "traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/verify?rd=https://auth.rodneyops.com}"
      - "traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardauth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.3"
    healthcheck:
      test:
        ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  ##############################################################################
  # SECURITY LAYER - Fail2ban
  ##############################################################################

  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=${TZ:-UTC}
      - F2B_DB_PURGE_AGE=30d
      - F2B_LOG_LEVEL=INFO
    volumes:
      - ./config/fail2ban:/data
      - ./config/traefik/logs:/var/log/traefik:ro
      - /var/log:/var/log:ro
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # MONITORING - Prometheus (Metrics Collection)
  ##############################################################################

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    networks:
      - monitoring
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
    volumes:
      - ./config/prometheus:/etc/prometheus
      - prometheus-data:/prometheus
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    healthcheck:
      test:
        ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  ##############################################################################
  # MONITORING - Grafana (Visualization)
  ##############################################################################

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - monitoring
      - public
    environment:
      - GF_SERVER_ROOT_URL=https://grafana.rodneyops.com
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=flant-statusmap-panel,grafana-piechart-panel
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_GENERIC_OAUTH_ENABLED=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.rodneyops.com`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=cloudflare"
      - "traefik.http.routers.grafana.middlewares=authelia@docker,security-headers@file"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.3"
    healthcheck:
      test:
        ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  ##############################################################################
  # MONITORING - Loki (Log Aggregation)
  ##############################################################################

  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped 
    networks:
      - monitoring
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ./config/loki:/etc/loki
      - loki-data:/loki
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.3"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  ##############################################################################
  # MONITORING - Promtail (Log Shipper)
  ##############################################################################

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    restart: unless-stopped
    networks:
      - monitoring
    volumes:
      - ./config/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./config/traefik/logs:/var/log/traefik:ro
    command: -config.file=/etc/promtail/promtail-config.yml
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # MONITORING - Node Exporter (System Metrics)
  ##############################################################################

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    networks:
      - monitoring
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/rootfs"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.1"

  ##############################################################################
  # MONITORING - cAdvisor (Container Metrics)
  ##############################################################################

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    networks:
      - monitoring
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # MONITORING - Uptime Kuma (Service Status)
  ##############################################################################

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - monitoring
      - public
    volumes:
      - ./config/uptime-kuma:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.uptime-kuma.rule=Host(`status.rodneyops.com`)"
      - "traefik.http.routers.uptime-kuma.entrypoints=websecure"
      - "traefik.http.routers.uptime-kuma.tls.certresolver=cloudflare"
      - "traefik.http.routers.uptime-kuma.middlewares=authelia@docker,security-headers@file"
      - "traefik.http.services.uptime-kuma.loadbalancer.server.port=3001"
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # NOTIFICATION - Gotify (Push Notifications)
  ##############################################################################

  gotify:
    image: gotify/server:latest
    container_name: gotify
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - public
    environment:
      - GOTIFY_DEFAULTUSER_NAME=${GOTIFY_ADMIN_USER:-admin}
      - GOTIFY_DEFAULTUSER_PASS=${GOTIFY_ADMIN_PASSWORD}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/gotify:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gotify.rule=Host(`rodify.rodneyops.com`)"
      - "traefik.http.routers.gotify.entrypoints=websecure"
      - "traefik.http.routers.gotify.tls.certresolver=cloudflare"
      - "traefik.http.routers.gotify.middlewares=authelia@docker,security-headers@file"
      - "traefik.http.services.gotify.loadbalancer.server.port=80"
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # PRIVATE SERVICES - Tailscale Subnet Router
  ##############################################################################

  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    restart: unless-stopped
    hostname: homelab-gateway
    networks:
      - private
    env_file:
      - .env
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_SERVE_CONFIG=/config/ts-homelab.json
      - TS_CERT_DOMAIN=kooka-lake.ts.net
      - TS_EXTRA_ARGS=--advertise-routes=172.21.0.0/24 --accept-routes
    volumes:
      - ./config/tailscale:/config
      - ./config/tailscale:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # PRIVATE SERVICES - Jellyfin Media Server
  ##############################################################################

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    network_mode: "service:tailscale"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${TAILSCALE_DOMAIN}
    volumes:
      - ./config/jellyfin/config:/config
      - ./config/jellyfin/cache:/cache
      - hetzner-media:/media:ro
    depends_on:
      - tailscale
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.5"

  ##############################################################################
  # PRIVATE SERVICES - Jellyseerr (Request Media Management and Monitoring)
  ##############################################################################

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    network_mode: "service:tailscale"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - APPLICATION_URL=https://jellyseerr.${TAILSCALE_DOMAIN}
    volumes:
      - ./config/jellyseerr:/config
    depends_on:
      - tailscale

  ##############################################################################
  # PRIVATE SERVICES - Gluetun VPN Client
  ##############################################################################

  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    restart: unless-stopped
    env_file:
      - .env
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - private
    ports:
      - "8085:8085" # qBittorrent
      - "9696:9696" # Prowlarr
      - "7878:7878" # Radarr
      - "8989:8989" # Sonarr
      - "8686:8686" # Lidarr
      - "5299:5299" # LazyLibrarian
      - "6767:6767" # Bazarr
      - "8191:8191" # flaresolverr
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_PROVIDER:-protonvpn}
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${VPN_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${VPN_ADDRESSES}
      - SERVER_COUNTRIES=${VPN_COUNTRIES:-Netherlands}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/gluetun:/gluetun
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.3"

  ##############################################################################
  # PRIVATE SERVICES - qBittorrent
  ##############################################################################

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    network_mode: "service:gluetun"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - WEBUI_PORT=8085
    volumes:
      - ./config/qbittorrent:/config
      - hetzner-media:/media
    depends_on:
      - gluetun
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  ##############################################################################
  # PRIVATE SERVICES - Prowlarr (Indexer Manager)
  ##############################################################################

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    network_mode: "service:gluetun"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/prowlarr:/config
    depends_on:
      - gluetun
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.3"

  ##############################################################################
  # PRIVATE SERVICES - Radarr (Movies)
  ##############################################################################

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    network_mode: "service:gluetun"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/radarr:/config
      - hetzner-media:/media
    depends_on:
      - gluetun
      - prowlarr
    deploy:
      resources:
        limits:
          memory: 192M
          cpus: "0.3"

  ##############################################################################
  # PRIVATE SERVICES - Sonarr (TV Shows)
  ##############################################################################

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    network_mode: "service:gluetun"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/sonarr:/config
      - hetzner-media:/media
    depends_on:
      - gluetun
      - prowlarr
    deploy:
      resources:
        limits:
          memory: 192M
          cpus: "0.3"

  ##############################################################################
  # PRIVATE SERVICES - Lidarr (Music)
  ##############################################################################

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    network_mode: "service:gluetun"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/lidarr:/config
      - hetzner-media:/media
    depends_on:
      - gluetun
      - prowlarr
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.3"

  ##############################################################################
  # PRIVATE SERVICES - LazyLibrarian (Books - Readarr replacement)
  ##############################################################################

  lazylibrarian:
    image: lscr.io/linuxserver/lazylibrarian:latest
    container_name: lazylibrarian
    restart: unless-stopped
    network_mode: "service:gluetun"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/lazylibrarian:/config
      - hetzner-media:/media
    depends_on:
      - gluetun
      - prowlarr
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  ##############################################################################
  # PRIVATE SERVICES - Bazarr (Subtitles)
  ##############################################################################

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    network_mode: "service:gluetun"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/bazarr:/config
      - hetzner-media:/media
    depends_on:
      - gluetun
      - radarr
      - sonarr
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # PRIVATE SERVICES - Homarr Dashboard
  ##############################################################################

  homarr:
    image: ghcr.io/ajnart/homarr:latest
    container_name: homarr
    restart: unless-stopped
    network_mode: "service:tailscale"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/homarr/configs:/app/data/configs
      - ./config/homarr/icons:/app/public/icons
      - ./config/homarr/data:/data
    depends_on:
      - tailscale
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # PRIVATE SERVICES - Flaresolverr (Proxy for Cloudflare DNS over Tor)
  ##############################################################################

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    network_mode: "service:gluetun"
    env_file:
      - .env
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/flaresolverr/config:/config
      - ./config/flaresolverr/data:/data
    depends_on:
      - gluetun

  ##############################################################################
  # PRIVATE SERVICES - Portainer (Container Management)
  ##############################################################################

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    network_mode: "service:tailscale"
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config/portainer:/data
    depends_on:
      - tailscale
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # MEDIA SERVICES - Navidrome (Music Streaming Server)
  ##############################################################################

  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    restart: unless-stopped
    networks:
      - private
      - public  # Required for Traefik to access
    env_file:
      - .env
    environment:
      - ND_SCANSCHEDULE=1h
      - ND_LOGLEVEL=info
      - ND_SESSIONTIMEOUT=24h
      - ND_BASEURL=
      - ND_ENABLETRANSCODINGCONFIG=true
      - ND_MUSICFOLDER=/music
      - ND_DATAFOLDER=/data
      - ND_CACHEFOLDER=/cache
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/navidrome:/data
      - ./server-data/navidrome/cache:/cache
      - hetzner-media:/music:ro # Read-only access to music on Storage Box
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.navidrome.rule=Host(`navidrome.rodneyops.com`)"
      - "traefik.http.routers.navidrome.entrypoints=websecure"
      - "traefik.http.routers.navidrome.priority=10"
      - "traefik.http.routers.navidrome.tls=true"
      - "traefik.http.routers.navidrome.tls.certresolver=cloudflare"
      - "traefik.http.routers.navidrome.middlewares=authelia@docker,security-headers@file"
      - "traefik.http.services.navidrome.loadbalancer.server.port=4533"
    depends_on:
      - traefik
      - authelia
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"

  ##############################################################################
  # MEDIA SERVICES - Audiobookshelf (Audiobook & Podcast Server)
  ##############################################################################

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    restart: unless-stopped
    networks:
      - private
      - public  # Required for Traefik to access
    env_file:
      - .env
    environment:
      - AUDIOBOOKSHELF_UID=${PUID:-1000}
      - AUDIOBOOKSHELF_GID=${PGID:-1000}
      - TZ=${TZ:-UTC}
    volumes:
      - ./config/audiobookshelf:/config
      - ./server-data/audiobookshelf/metadata:/metadata
      - hetzner-media:/audiobooks:ro # Read-only access to audiobooks on Storage Box
      - hetzner-media:/podcasts:ro # Read-only access to podcasts on Storage Box
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.audiobookshelf.rule=Host(`audiobooks.rodneyops.com`)"
      - "traefik.http.routers.audiobookshelf.entrypoints=websecure"
      - "traefik.http.routers.audiobookshelf.priority=10"
      - "traefik.http.routers.audiobookshelf.tls=true"
      - "traefik.http.routers.audiobookshelf.tls.certresolver=cloudflare"
      - "traefik.http.routers.audiobookshelf.middlewares=authelia@docker,security-headers@file"
      - "traefik.http.services.audiobookshelf.loadbalancer.server.port=80"
    depends_on:
      - traefik
      - authelia
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
