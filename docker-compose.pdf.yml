##############################################################################
# PDF MANAGEMENT - Paperless-ngx
# Document management system with OCR
##############################################################################

volumes:
  # Reference external hetzner-media volume
  hetzner-media:
    external: true
    name: homelab_hetzner-media
  
  # Paperless internal volumes
  paperless-data:
  paperless-db:
  paperless-redis-data:
  stirling-data:
  stirling-db:
  stirling-redis-data:

services:
  ##############################################################################
  # NETWORK GATEWAY - Tailscale
  ##############################################################################

  paperless-ts:
    image: tailscale/tailscale:latest
    container_name: paperless-ts
    hostname: paperless
    env_file:
      - .env
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/tailscale/paperless/ts-paperless.json
      - TS_CERT_DOMAIN=pdf.kooka-lake.ts.net
      - TS_USERSPACE=true
    volumes:
      - ./config/tailscale/paperless:/config
      - ./config/tailscale/paperless:/var/lib/tailscale
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /var/tmp
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # DATABASE - PostgreSQL
  ##############################################################################

  paperless-db:
    image: postgres:15-alpine
    container_name: paperless-db
    restart: unless-stopped
    networks: service:paperless-ts
    environment:
      - POSTGRES_USER=paperless
      - POSTGRES_PASSWORD=${PAPERLESS_DB_PASSWORD:-paperless}
      - POSTGRES_DB=paperless
      - TZ=${TZ:-UTC}
    volumes:
      - paperless-db:/var/lib/postgresql/data
    security_opt:
      - no-new-privileges:true
    user: "999:999"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U paperless"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # CACHE - Redis
  ##############################################################################

  paperless-redis:
    image: redis:7-alpine
    container_name: paperless-redis
    restart: unless-stopped
    networks:
      - paperless
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - paperless-redis-data:/data
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    user: "999:999"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # APPLICATION - Paperless-ngx
  ##############################################################################

  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless
    restart: unless-stopped
    networks: service:paperless-ts
    env_file:
      - .env
    environment:
      - PAPERLESS_URL=https://pdf.kooka-lake.ts.net
      - PAPERLESS_SECRET_KEY=${PAPERLESS_SECRET_KEY:-change-me}
      - PAPERLESS_TIME_ZONE=${TZ:-UTC}
      - PAPERLESS_OCR_LANGUAGE=${PAPERLESS_OCR_LANGUAGE:-eng}
      - PAPERLESS_DBENGINE=postgresql
      - PAPERLESS_DBHOST=paperless-db
      - PAPERLESS_DBPORT=5432
      - PAPERLESS_DBNAME=paperless
      - PAPERLESS_DBUSER=paperless
      - PAPERLESS_DBPASS=${PAPERLESS_DB_PASSWORD:-paperless}
      - PAPERLESS_REDIS=redis://paperless-redis:6379
      - PAPERLESS_CONSUMPTION_DIR=/usr/src/paperless/consume
      - PAPERLESS_DATA_DIR=/usr/src/paperless/data
      - PAPERLESS_MEDIA_ROOT=/usr/src/paperless/media
      - PAPERLESS_STATICFILES_DIR=/usr/src/paperless/static
      - TZ=${TZ:-UTC}
    volumes:
      - paperless-data:/usr/src/paperless/data
      - paperless-data:/usr/src/paperless/media
      - paperless-data:/usr/src/paperless/consume
      - paperless-data:/usr/src/paperless/static
      - hetzner-media:/documents:ro
    depends_on:
      paperless-db:
        condition: service_healthy
      paperless-redis:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    user: "1000:1000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/api/"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # PDF MANAGEMENT - Stirling-pdf
  ##############################################################################

  stirling-ts:
    image: tailscale/tailscale:latest
    container_name: stirling-ts
    hostname: orthanc
    env_file:
      - .env
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTH_KEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/tailscale/stirling-pdf/ts-stirling-pdf.json
      - TS_CERT_DOMAIN=orthanc.kooka-lake.ts.net
      - TS_USERSPACE=true
    volumes:
      - ./config/tailscale/stirling-pdf:/config
      - ./config/tailscale/stirling-pdf:/var/lib/tailscale
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /var/tmp
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "tailscale", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  ##############################################################################
  # PDF MANAGEMENT - Stirling-pdf
  ##############################################################################

  # Backend - PDF processing engine
  stirling-backend:
    image: stirlingtools/stirling-pdf:latest
    container_name: stirling-backend
    restart: unless-stopped
    networks: service:stirling-ts
    env_file:
      - .env
    environment:
      - SECURITY_ENABLELOGIN=true
      - LANGS=en,fi
      - MODE=BACKEND
      - TZ=${TZ:-UTC}
    # Check folder permissions: chmod -R 755 ./stirling-data
    volumes:
      - stirling-data/tessdata:/usr/share/tessdata  # OCR language files
      - stirling-data/configs:/configs               # Settings & database
      - stirling-dat/logs:/logs                     # Application logs
      - stirling-data/pipeline:/pipeline             # Automation configs
      - hetzner-media:/documents:ro
    depends_on:
      stirling-db:
        condition: service_healthy
      stirling-redis:
        condition: service_healthy
    #security_opt:
    #  - no-new-privileges:true
    #read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    #user: "1000:1000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/api/"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  # Frontend - PDF viewer
  stirling-pdf-frontend:
    image: stirlingtools/stirling-pdf-frontend:latest
    container_name: stirling-frontend
    restart: unless-stopped
    networks: service:stirling-ts
    env_file:
      - .env
    environment:
      - SECURITY_ENABLELOGIN=true
      - MODE=FRONTEND
      - LANGS=en,fi
      - TZ=${TZ:-UTC}
      - VITE_API_BASE_URL=http://stirling-backend:8080
    volumes:
      - stirling-data:/usr/src/stirling/data
