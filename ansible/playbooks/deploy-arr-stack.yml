##############################################################################
# ANSIBLE PLAYBOOK - Deploy Arr Stack
# Deploys Gluetun and all Arr services
##############################################################################

---
- name: Deploy Arr Stack
  hosts: production
  become: yes
  become_user: root
  gather_facts: yes
  
  vars_files:
    - vault.yml
  
  vars:
    deploy_path: "{{ hostvars[inventory_hostname]['deploy_path'] | default('/opt/homelab') }}"
    compose_file_name: "docker-compose.arr-stack.yml"
    compose_file_path: "{{ deploy_path }}/{{ compose_file_name }}"
    compose_file_requires_tailscale: false  # ARR stack has its own Tailscale service (ts-anduin)

  pre_tasks:
    - name: Ensure deployment directory exists
      file:
        path: "{{ deploy_path }}"
        state: directory
        owner: deploy
        group: deploy
        mode: '0755'

  roles:
    - role: sync_config
      tags: ['config', 'sync']

    - role: sync_secrets
      tags: ['secrets', 'sync']

    - role: deploy_compose
      tags: ['deploy', 'services']

    - role: fix_permissions
      tags: ['permissions', 'fix']

  post_tasks:
    - name: Ensure ts-anduin is started first (required for network_mode: service:ts-anduin)
      command: "docker compose -f {{ compose_file_path }} up -d ts-anduin"
      args:
        chdir: "{{ deploy_path }}"
      register: ts_anduin_start
      failed_when: false
      tags: ['deploy', 'services']

    - name: Wait for ts-anduin to be ready
      pause:
        seconds: 15
      tags: ['deploy', 'services']

    - name: Restart Jellyfin and Jellyseerr to ensure network connection (network_mode: service:ts-anduin)
      command: "docker compose -f {{ compose_file_path }} restart {{ item }}"
      args:
        chdir: "{{ deploy_path }}"
      loop:
        - jellyfin
        - jellyseerr
      register: restart_result
      failed_when: false
      tags: ['deploy', 'services']

    - name: Wait for services to stabilize after restart
      pause:
        seconds: 15
      tags: ['deploy', 'services']

    - name: Fix Jellyfin database permissions (critical for startup)
      file:
        path: "{{ deploy_path }}/config/jellyfin/config"
        owner: "{{ puid | default(1000) }}"
        group: "{{ pgid | default(1000) }}"
        mode: '0755'
        recurse: yes
      tags: ['permissions', 'fix']

    - name: Fix Jellyfin database files permissions
      shell: |
        find {{ deploy_path }}/config/jellyfin/config -type f \( -name "*.db" -o -name "*.db-shm" -o -name "*.db-wal" \) -exec chmod 664 {} \; 2>/dev/null || true
        find {{ deploy_path }}/config/jellyfin/config -type d -exec chmod 755 {} \; 2>/dev/null || true
      changed_when: false
      tags: ['permissions', 'fix']

    - name: Check if jellyfin-auto-collections config exists
      stat:
        path: "{{ deploy_path }}/config/jellyfin/jellyfin-plugins/auto-collections/config.yaml"
      register: auto_collections_config
      tags: ['permissions', 'fix']

    - name: Verify jellyfin-auto-collections config uses localhost for Jellyfin
      lineinfile:
        path: "{{ deploy_path }}/config/jellyfin/jellyfin-plugins/auto-collections/config.yaml"
        regexp: '^(\s*)server_url:\s*!ENV.*JELLYFIN_SERVER_URL.*anduin\.kooka-lake\.ts\.net'
        line: '\1server_url: !ENV ${JELLYFIN_SERVER_URL:http://localhost:8096}'
        backup: yes
      when: auto_collections_config.stat.exists | default(false)
      tags: ['permissions', 'fix']

    - name: Verify jellyfin-auto-collections config uses localhost for Jellyseerr
      lineinfile:
        path: "{{ deploy_path }}/config/jellyfin/jellyfin-plugins/auto-collections/config.yaml"
        regexp: '^(\s*)server_url:\s*!ENV.*JELLYSEERR_URL.*anduin\.kooka-lake\.ts\.net'
        line: '\1server_url: !ENV ${JELLYSEERR_URL:http://localhost:5055}'
        backup: yes
      when: auto_collections_config.stat.exists | default(false)
      tags: ['permissions', 'fix']

    - name: Display deployment summary
      debug:
        msg:
          - "âœ… Arr stack deployment completed!"
          - "ðŸ“Š Services: {{ deploy_path }}/{{ compose_file_name }}"
          - "âœ… Permissions fixed for Jellyfin ({{ puid | default(1000) }}:{{ pgid | default(1000) }})"
          - "âœ… Config files verified (localhost URLs)"

