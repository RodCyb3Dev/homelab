##############################################################################
# ANSIBLE PLAYBOOK - Deploy Media Services
# Deploys Audiobookshelf and Navidrome
##############################################################################

---
- name: Deploy Media Services Stack
  hosts: production
  become: yes
  become_user: root
  gather_facts: yes
  
  vars_files:
    - vault.yml
  
  vars:
    deploy_path: "{{ hostvars[inventory_hostname]['deploy_path'] | default('/opt/homelab') }}"
    compose_file_name: "docker-compose.media.yml"
    compose_file_path: "{{ deploy_path }}/{{ compose_file_name }}"
    compose_file_requires_tailscale: false  # Media stack has its own Tailscale services

  pre_tasks:
    - name: Ensure deployment directory exists
      file:
        path: "{{ deploy_path }}"
        state: directory
        owner: deploy
        group: deploy
        mode: '0755'

  roles:
    - role: install_homelab_tools
      tags: ['install', 'tools']

    - role: sync_config
      tags: ['config', 'sync']

    - role: sync_secrets
      tags: ['secrets', 'sync']

    - role: deploy_compose
      tags: ['deploy', 'services']

  post_tasks:
    - name: Ensure Tailscale services are started first (required for network_mode service)
      command: "docker compose -f {{ compose_file_path }} up -d {{ item }}"
      args:
        chdir: "{{ deploy_path }}"
      loop:
        - audiobookshelf-ts
        - navidrome-ts
      register: ts_start
      failed_when: false
      tags: ['deploy', 'services']

    - name: Wait for Tailscale services to be ready
      pause:
        seconds: 15
      tags: ['deploy', 'services']

    - name: Start media services
      command: "docker compose -f {{ compose_file_path }} up -d {{ item }}"
      args:
        chdir: "{{ deploy_path }}"
      loop:
        - audiobookshelf
        - navidrome
      register: media_start
      failed_when: false
      tags: ['deploy', 'services']

    - name: Display deployment summary
      debug:
        msg:
          - "âœ… Media services stack deployment completed!"
          - "ðŸ“š Audiobookshelf: https://gandalf.kooka-lake.ts.net"
          - "ðŸŽµ Navidrome: https://bard.kooka-lake.ts.net"
          - "ðŸ“Š Services: {{ deploy_path }}/{{ compose_file_name }}"
