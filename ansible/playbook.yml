##############################################################################
# ANSIBLE PLAYBOOK - Homelab Deployment (Core Infrastructure)
# Manages deployment of core infrastructure only
# For individual services, use playbooks in playbooks/ directory
##############################################################################

---
- name: Deploy Core Infrastructure
  hosts: production
  become: yes
  become_user: root
  gather_facts: yes
  
  # Load vault file - password comes from ANSIBLE_VAULT_PASS env var via vault_password_file
  vars_files:
    - vault.yml
  
  vars:
    deploy_path: "{{ hostvars[inventory_hostname]['deploy_path'] | default('/opt/homelab') }}"
    domain: "{{ hostvars[inventory_hostname]['domain'] | default('rodneyops.com') }}"
    timezone: "{{ hostvars[inventory_hostname]['timezone'] | default('Europe/Helsinki') }}"
    compose_file_name: "docker-compose.yml"
    compose_file_path: "{{ deploy_path }}/{{ compose_file_name }}"
    compose_file_requires_tailscale: false

  pre_tasks:
    - name: Ensure deployment directory exists
      file:
        path: "{{ deploy_path }}"
        state: directory
        owner: deploy
        group: deploy
        mode: '0755'

    - name: Check disk space
      shell: df -h / | awk 'NR==2 {print $5}' | sed 's/%//'
      register: disk_usage
      changed_when: false
      failed_when: disk_usage.stdout | int > 90
      tags: always

  roles:
    - role: install_homelab_tools
      tags: ['install', 'tools']

    - role: sync_config
      tags: ['config', 'sync']

    - role: sync_secrets
      tags: ['secrets', 'sync']

    - role: deploy_compose
      tags: ['deploy', 'services']

    - role: health_check
      tags: ['health', 'verify']

  post_tasks:
    - name: Cleanup old Docker images
      command: docker image prune -f
      changed_when: false
      tags: cleanup

    - name: Display deployment summary
      debug:
        msg:
          - "âœ… Core infrastructure deployment completed successfully!"
          - "ğŸ“Š Services: {{ deploy_path }}/{{ compose_file_name }}"
          - "ğŸŒ Domain: {{ domain }}"
          - "â° Timezone: {{ timezone }}"
          - "ğŸ’¡ To deploy individual services, use: ansible-playbook playbooks/deploy-<service>.yml"
