##############################################################################
# DEPLOY SERVICES ROLE - Manage docker-compose services
# Handles rolling updates and service orchestration
##############################################################################

---
- name: Check if docker compose (v2) is available
  command: docker compose version
  register: docker_compose_v2_check
  changed_when: false
  failed_when: false
  tags: deploy_services

- name: Check if docker-compose (v1) is available
  command: docker-compose version
  register: docker_compose_v1_check
  changed_when: false
  failed_when: false
  when: docker_compose_v2_check.rc != 0
  tags: deploy_services

- name: Set docker compose command
  set_fact:
    docker_compose_cmd: "{{ 'docker compose' if docker_compose_v2_check.rc == 0 else 'docker-compose' }}"
  tags: deploy_services

- name: Fail if neither docker compose nor docker-compose is available
  fail:
    msg: "Neither 'docker compose' (v2) nor 'docker-compose' (v1) is installed. Please install Docker Compose first."
  when: docker_compose_v2_check.rc != 0 and docker_compose_v1_check.rc != 0
  tags: deploy_services

- name: Pull latest Docker images
  command: "{{ docker_compose_cmd }} pull"
  args:
    chdir: "{{ deploy_path }}"
  environment:
    COMPOSE_FILE: "{{ deploy_path }}/{{ docker_compose_file }}"
  register: pull_result
  changed_when: "'up to date' not in pull_result.stdout"
  failed_when: false  # Continue even if some images fail to pull (may not have amd64)
  tags: deploy_services

- name: Display pull warnings
  debug:
    msg: "{{ pull_result.stderr_lines | select('match', '.*manifest.*') | list }}"
  when: pull_result.stderr is defined and pull_result.stderr != ""
  tags: deploy_services

- name: Get list of services from docker compose
  command: "{{ docker_compose_cmd }} config --services"
  args:
    chdir: "{{ deploy_path }}"
  register: services_list
  changed_when: false
  tags: deploy_services

- name: Display services to be deployed
  debug:
    msg: "Services to deploy: {{ services_list.stdout_lines }}"
  tags: deploy_services

- name: Start Authelia first (required for Traefik middleware)
  command: "{{ docker_compose_cmd }} up -d --remove-orphans --force-recreate authelia"
  args:
    chdir: "{{ deploy_path }}"
  environment:
    COMPOSE_FILE: "{{ deploy_path }}/{{ docker_compose_file }}"
  when: "'authelia' in services_list.stdout_lines"
  register: authelia_deploy
  failed_when: false
  tags: deploy_services

- name: Wait for Authelia to be healthy
  wait_for:
    path: "{{ deploy_path }}/config/authelia/configuration.yml"
    timeout: 60
  when: "'authelia' in services_list.stdout_lines"
  tags: deploy_services

- name: Wait for Authelia container to be running
  wait_for:
    host: "{{ ansible_host }}"
    port: 9091
    delay: 5
    timeout: 60
  when: "'authelia' in services_list.stdout_lines"
  ignore_errors: true
  tags: deploy_services

- name: Deploy services with rolling update (excluding Authelia which was started first)
  command: "{{ docker_compose_cmd }} up -d --remove-orphans --force-recreate {{ item }}"
  args:
    chdir: "{{ deploy_path }}"
  environment:
    COMPOSE_FILE: "{{ deploy_path }}/{{ docker_compose_file }}"
  loop: "{{ services_list.stdout_lines | reject('equalto', 'authelia') | list }}"
  register: deploy_result
  failed_when: false  # Continue even if some services fail (e.g., storage box mount issues)
  tags: deploy_services

- name: Display deployment failures
  debug:
    msg: "Service {{ item.item }} failed to deploy: {{ item.stderr_lines | default([]) | select('match', '.*error.*|.*fail.*') | list }}"
  loop: "{{ deploy_result.results | default([]) }}"
  when: item.rc != 0
  tags: deploy_services

- name: Wait for services to start
  pause:
    seconds: 10
  tags: deploy_services

- name: Verify services are running
  command: "{{ docker_compose_cmd }} ps"
  args:
    chdir: "{{ deploy_path }}"
  register: services_status
  changed_when: false
  tags: deploy_services

- name: Display service status
  debug:
    var: services_status.stdout_lines
  tags: deploy_services
