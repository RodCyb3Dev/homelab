##############################################################################
# SYNC SECRETS ROLE - Manage secrets and environment variables
# Creates .env file from Ansible vault or environment variables
##############################################################################

---
- name: Load secrets from environment or vault
  set_fact:
    secrets:
      DOMAIN: "{{ lookup('env', 'DOMAIN') | default(vault_domain | default('')) }}"
      TZ: "{{ lookup('env', 'TIMEZONE') | default(vault_timezone | default('UTC')) }}"
      PGID: "{{ lookup('env', 'PGID') | default(vault_pgid | default('1000')) }}"
      PUID: "{{ lookup('env', 'PUID') | default(vault_puid | default('1000')) }}"
      BASIC_AUTH: "{{ lookup('env', 'BASIC_AUTH') | default(vault_basic_auth | default('')) }}"
      STORAGE_BOX_PASSWORD: "{{ lookup('env', 'STORAGE_BOX_PASSWORD') | default(vault_storage_box_password | default('')) }}"
      STORAGE_BOX_USER: "{{ lookup('env', 'STORAGE_BOX_USER') | default(vault_storage_box_user | default('')) }}"
      STORAGE_BOX_HOST: "{{ lookup('env', 'STORAGE_BOX_HOST') | default(vault_storage_box_host | default('')) }}"
      POSTGRESQL_PASSWORD: "{{ lookup('env', 'POSTGRESQL_PASSWORD') | default(vault_postgresql_password | default('')) }}"
      REDIS_PASSWORD: "{{ lookup('env', 'REDIS_PASSWORD') | default(vault_redis_password | default('')) }}"
      CROWDSEC_ENROLL_KEY: "{{ lookup('env', 'CROWDSEC_ENROLL_KEY') | default(vault_crowdsec_enroll_key | default('')) }}"
      CROWDSEC_BOUNCER_API_KEY: "{{ lookup('env', 'CROWDSEC_BOUNCER_KEY') | default(vault_crowdsec_bouncer_key | default('')) }}"
      GRAFANA_ADMIN_USER: "{{ lookup('env', 'GRAFANA_ADMIN_USER') | default(vault_grafana_admin_user | default('admin')) }}"
      GRAFANA_ADMIN_PASSWORD: "{{ lookup('env', 'GRAFANA_ADMIN_PASSWORD') | default(vault_grafana_admin_password | default('')) }}"
      GOTIFY_ADMIN_USER: "{{ lookup('env', 'GOTIFY_ADMIN_USER') | default(vault_gotify_admin_user | default('admin')) }}"
      GOTIFY_ADMIN_PASSWORD: "{{ lookup('env', 'GOTIFY_ADMIN_PASSWORD') | default(vault_gotify_admin_password | default('')) }}"
      TS_AUTHKEY: "{{ lookup('env', 'TS_AUTHKEY') | default(vault_tailscale_auth_key | default('')) }}"
      TAILSCALE_DOMAIN: "{{ lookup('env', 'TAILSCALE_DOMAIN') | default(vault_tailscale_domain | default('kooka-lake.ts.net')) }}"
      TAILSCALE_AUTH_KEY: "{{ lookup('env', 'TAILSCALE_AUTH_KEY') | default(vault_tailscale_auth_key | default('')) }}"
      CF_API_TOKEN: "{{ lookup('env', 'CF_API_TOKEN') | default(vault_cf_api_token | default('')) }}"
      CF_API_EMAIL: "{{ lookup('env', 'CF_API_EMAIL') | default(vault_cf_api_email | default('')) }}"
      LE_EMAIL_SSL: "{{ lookup('env', 'LE_EMAIL_SSL') | default(vault_le_email_ssl | default('')) }}"
      AUTHELIA_STORAGE_POSTGRES_PASSWORD: "{{ lookup('env', 'AUTHELIA_STORAGE_POSTGRES_PASSWORD') | default(vault_authelia_storage_postgres_password | default('')) }}"
      AUTHELIA_JWT_SECRET: "{{ lookup('env', 'AUTHELIA_JWT_SECRET') | default(vault_authelia_jwt_secret | default('')) }}"
      AUTHELIA_STORAGE_ENCRYPTION_KEY: "{{ lookup('env', 'AUTHELIA_STORAGE_ENCRYPTION_KEY') | default(vault_authelia_storage_encryption_key | default('')) }}"
      AUTHELIA_SESSION_SECRET: "{{ lookup('env', 'AUTHELIA_SESSION_SECRET') | default(vault_authelia_session_secret | default('')) }}"
      AUTHELIA_NOTIFIER_SMTP_PASSWORD: "{{ lookup('env', 'AUTHELIA_NOTIFIER_SMTP_PASSWORD') | default(vault_authelia_notifier_smtp_password | default('')) }}"
      AUTHELIA_SMTP_USERNAME: "{{ lookup('env', 'AUTHELIA_SMTP_USERNAME') | default(vault_authelia_smtp_username | default(lookup('env', 'SMTP_USERNAME') | default(vault_smtp_username | default('')))) }}"
      BACKUP_ENCRYPTION_KEY: "{{ lookup('env', 'BACKUP_ENCRYPTION_KEY') | default(vault_backup_encryption_key | default('')) }}"
      SMTP_HOST: "{{ lookup('env', 'SMTP_HOST') | default(vault_smtp_host | default('')) }}"
      SMTP_PORT: "{{ lookup('env', 'SMTP_PORT') | default(vault_smtp_port | default('')) }}"
      SMTP_USERNAME: "{{ lookup('env', 'SMTP_USERNAME') | default(vault_smtp_username | default('')) }}"
      SMTP_PASSWORD: "{{ lookup('env', 'SMTP_PASSWORD') | default(vault_smtp_password | default('')) }}"
      VPN_PRIVATE_KEY: "{{ lookup('env', 'VPN_PRIVATE_KEY') | default(vault_vpn_private_key | default('')) }}"
      VPN_ADDRESSES: "{{ lookup('env', 'VPN_ADDRESSES') | default(vault_vpn_addresses | default('')) }}"
      VPN_PROVIDER: "{{ lookup('env', 'VPN_PROVIDER') | default(vault_vpn_provider | default('')) }}"
      VPN_COUNTRIES: "{{ lookup('env', 'VPN_COUNTRIES') | default(vault_vpn_countries | default('')) }}"
      IMMICH_VERSION: "{{ lookup('env', 'IMMICH_VERSION') | default(vault_immich_version | default('')) }}"
      IMMICH_DB_USER: "{{ lookup('env', 'IMMICH_DB_USER') | default(vault_immich_db_user | default('')) }}"
      IMMICH_DB_PASSWORD: "{{ lookup('env', 'IMMICH_DB_PASSWORD') | default(vault_immich_db_password | default('')) }}"
      IMMICH_DB_NAME: "{{ lookup('env', 'IMMICH_DB_NAME') | default(vault_immich_db_name | default('')) }}"
      IMMICH_REDIS_PASSWORD: "{{ lookup('env', 'IMMICH_REDIS_PASSWORD') | default(vault_immich_redis_password | default('')) }}"
      IMMICH_SB_HOST: "{{ lookup('env', 'IMMICH_SB_HOST') | default(vault_immich_sb_host | default('')) }}"
      IMMICH_SB_USER: "{{ lookup('env', 'IMMICH_SB_USER') | default(vault_immich_sb_user | default('')) }}"
      IMMICH_SB_PASSWORD: "{{ lookup('env', 'IMMICH_SB_PASSWORD') | default(vault_immich_sb_password | default('')) }}"
      IMMICH_SB_PORT: "{{ lookup('env', 'IMMICH_SB_PORT') | default(vault_immich_sb_port | default('')) }}"
      JELLYFIN_PUBLISHED_URL: "{{ lookup('env', 'JELLYFIN_PUBLISHED_URL') | default(vault_jellyfin_published_url | default('')) }}"
      # Pangolin configuration
      PANGOLIN_SMTP_HOST: "{{ lookup('env', 'SMTP_HOST') | default(vault_smtp_host | default('smtp.protonmail.ch')) }}"
      PANGOLIN_SMTP_PORT: "{{ lookup('env', 'SMTP_PORT') | default(vault_smtp_port | default('587')) }}"
      PANGOLIN_SMTP_USER: "{{ lookup('env', 'SMTP_USER') | default(vault_smtp_username | default('info@kodeflash.dev')) }}"
      PANGOLIN_SMTP_PASS: "{{ lookup('env', 'SMTP_PASSWORD') | default(vault_smtp_password | default('')) }}"
      PANGOLIN_NO_REPLY_EMAIL: "{{ lookup('env', 'NO_REPLY_EMAIL') | default(vault_no_reply_email | default('no-reply@kodeflash.dev')) }}"
      PANGOLIN_ADMIN_EMAIL: "{{ lookup('env', 'PANGOLIN_ADMIN_EMAIL') | default(vault_pangolin_admin_email | default('rodney@kodeflash.dev')) }}"
      PANGOLIN_ADMIN_PASSWORD: "{{ lookup('env', 'PANGOLIN_ADMIN_PASSWORD') | default(vault_pangolin_admin_password | default('')) }}"
      ADMIN_EMAIL: "{{ lookup('env', 'ADMIN_EMAIL') | default(vault_admin_email | default('rodney@kodeflash.dev')) }}"
      ADMIN_PASSWORD: "{{ lookup('env', 'ADMIN_PASSWORD') | default(vault_admin_password | default('')) }}"
      # Gerbil configuration
      GERBIL_REACHABLE_URL: "{{ lookup('env', 'GERBIL_REACHABLE_URL') | default(vault_gerbil_reachable_url | default('')) }}"
      GERBIL_KEY_PATH: "{{ lookup('env', 'GERBIL_KEY_PATH') | default(vault_gerbil_key_path | default('')) }}"
      GERBIL_CONFIG_URL: "{{ lookup('env', 'GERBIL_CONFIG_URL') | default(vault_gerbil_config_url | default('')) }}"
      GERBIL_BANDWIDTH_URL: "{{ lookup('env', 'GERBIL_BANDWIDTH_URL') | default(vault_gerbil_bandwidth_url | default('')) }}"

  no_log: true
  tags: sync_secrets

- name: Create .env file for docker-compose
  template:
    src: env.j2
    dest: "{{ deploy_path }}/.env"
    owner: deploy
    group: deploy
    mode: '0600'
  vars:
    env_vars: "{{ secrets }}"
  no_log: true
  tags: sync_secrets

- name: Ensure Authelia secrets directory exists
  file:
    path: "{{ deploy_path }}/config/authelia/secrets"
    state: directory
    owner: deploy
    group: deploy
    mode: '0700'
  tags: sync_secrets

- name: Create Authelia JWT_SECRET file from vault
  copy:
    content: "{{ secrets.AUTHELIA_JWT_SECRET | default('') }}"
    dest: "{{ deploy_path }}/config/authelia/secrets/JWT_SECRET"
    owner: deploy
    group: deploy
    mode: '0600'
  when: secrets.AUTHELIA_JWT_SECRET | default('') != ''
  no_log: true
  tags: sync_secrets

- name: Create Authelia SESSION_SECRET file from vault
  copy:
    content: "{{ secrets.AUTHELIA_SESSION_SECRET | default('') }}"
    dest: "{{ deploy_path }}/config/authelia/secrets/SESSION_SECRET"
    owner: deploy
    group: deploy
    mode: '0600'
  when: secrets.AUTHELIA_SESSION_SECRET | default('') != ''
  no_log: true
  tags: sync_secrets

- name: Create Authelia STORAGE_PASSWORD file from vault
  copy:
    content: "{{ secrets.AUTHELIA_STORAGE_POSTGRES_PASSWORD | default('') }}"
    dest: "{{ deploy_path }}/config/authelia/secrets/STORAGE_PASSWORD"
    owner: deploy
    group: deploy
    mode: '0600'
  when: secrets.AUTHELIA_STORAGE_POSTGRES_PASSWORD | default('') != ''
  no_log: true
  tags: sync_secrets

- name: Create Authelia STORAGE_ENCRYPTION_KEY file from vault
  copy:
    content: "{{ secrets.AUTHELIA_STORAGE_ENCRYPTION_KEY | default('') }}"
    dest: "{{ deploy_path }}/config/authelia/secrets/STORAGE_ENCRYPTION_KEY"
    owner: deploy
    group: deploy
    mode: '0600'
  when: secrets.AUTHELIA_STORAGE_ENCRYPTION_KEY | default('') != ''
  no_log: true
  tags: sync_secrets

- name: Create Authelia AUTHELIA_SMTP_USERNAME file from vault
  copy:
    content: "{{ secrets.AUTHELIA_SMTP_USERNAME | default('') }}"
    dest: "{{ deploy_path }}/config/authelia/secrets/AUTHELIA_SMTP_USERNAME"
    owner: deploy
    group: deploy
    mode: '0600'
  when: secrets.AUTHELIA_SMTP_USERNAME | default('') != ''
  no_log: true
  tags: sync_secrets

- name: Create Authelia AUTHELIA_NOTIFIER_SMTP_PASSWORD file from vault
  copy:
    content: "{{ secrets.AUTHELIA_NOTIFIER_SMTP_PASSWORD | default('') }}"
    dest: "{{ deploy_path }}/config/authelia/secrets/AUTHELIA_NOTIFIER_SMTP_PASSWORD"
    owner: deploy
    group: deploy
    mode: '0600'
  when: secrets.AUTHELIA_NOTIFIER_SMTP_PASSWORD | default('') != ''
  no_log: true
  tags: sync_secrets

- name: Generate Authelia secrets if vault values are empty
  shell: |
    if [ ! -s "{{ deploy_path }}/config/authelia/secrets/{{ item.name }}" ]; then
      openssl rand -hex 32 > "{{ deploy_path }}/config/authelia/secrets/{{ item.name }}"
      chmod 600 "{{ deploy_path }}/config/authelia/secrets/{{ item.name }}"
      chown deploy:deploy "{{ deploy_path }}/config/authelia/secrets/{{ item.name }}"
    fi
  loop:
    - { name: "JWT_SECRET", vault_key: "AUTHELIA_JWT_SECRET" }
    - { name: "SESSION_SECRET", vault_key: "AUTHELIA_SESSION_SECRET" }
    - { name: "STORAGE_PASSWORD", vault_key: "AUTHELIA_STORAGE_POSTGRES_PASSWORD" }
    - { name: "STORAGE_ENCRYPTION_KEY", vault_key: "AUTHELIA_STORAGE_ENCRYPTION_KEY" }
  when: secrets[item.vault_key] | default('') == ''
  changed_when: false
  no_log: true
  tags: sync_secrets

- name: Ensure Traefik Cloudflare API token file exists
  file:
    path: "{{ deploy_path }}/config/traefik/cf_api_token.txt"
    state: touch
    owner: deploy
    group: deploy
    mode: '0600'
  tags: sync_secrets

- name: Set Cloudflare API token from environment variable
  copy:
    content: "{{ lookup('env', 'CF_API_TOKEN') | default(vault_cf_api_token | default('')) }}"
    dest: "{{ deploy_path }}/config/traefik/cf_api_token.txt"
    owner: deploy
    group: deploy
    mode: '0600'
  when: lookup('env', 'CF_API_TOKEN') | default(vault_cf_api_token | default('')) != ''
  no_log: true
  tags: sync_secrets

- name: Sync secret files (if provided via vault)
  copy:
    src: "{{ item.src }}"
    dest: "{{ deploy_path }}/{{ item.dest }}"
    owner: deploy
    group: deploy
    mode: '0600'
    remote_src: false
  loop: "{{ secret_files | default([]) }}"
  when: secret_files is defined
  no_log: true
  tags: sync_secrets

- name: Set Pangolin config variables
  set_fact:
    pangolin_vars:
      smtp_host: "{{ secrets.PANGOLIN_SMTP_HOST }}"
      smtp_port: "{{ secrets.PANGOLIN_SMTP_PORT }}"
      smtp_user: "{{ secrets.PANGOLIN_SMTP_USER }}"
      smtp_pass: "{{ secrets.PANGOLIN_SMTP_PASS }}"
      no_reply_email: "{{ secrets.PANGOLIN_NO_REPLY_EMAIL }}"
      admin_email: "{{ secrets.PANGOLIN_ADMIN_EMAIL }}"
      admin_password: "{{ secrets.PANGOLIN_ADMIN_PASSWORD }}"
  no_log: true
  tags: sync_secrets
