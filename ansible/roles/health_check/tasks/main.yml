##############################################################################
# HEALTH CHECK ROLE - Verify service health after deployment
##############################################################################

---
- name: Wait for services to be healthy
  pause:
    seconds: 30
  tags: health_check

- name: Check critical services are running
  command: docker compose ps --filter "status=running" --format "{{ '{{.Name}}' }}"
  args:
    chdir: "{{ deploy_path }}"
  register: running_services
  changed_when: false
  tags: health_check

- name: Verify Caddy is running
  command: docker ps --filter "name=caddy" --filter "status=running" --format "{{ '{{.Names}}' }}"
  register: caddy_check
  changed_when: false
  failed_when: caddy_check.stdout == ""
  tags: health_check

- name: Verify CrowdSec is running
  command: docker ps --filter "name=crowdsec" --filter "status=running" --format "{{ '{{.Names}}' }}"
  register: crowdsec_check
  changed_when: false
  failed_when: false  # Don't fail deployment if CrowdSec isn't running
  tags: health_check

- name: Warn if CrowdSec is not running
  debug:
    msg: "⚠️  CrowdSec is not running. Check logs: docker logs crowdsec"
  when: crowdsec_check.stdout == ""
  tags: health_check

- name: Verify Authelia is running
  command: docker ps --filter "name=authelia" --filter "status=running" --format "{{ '{{.Names}}' }}"
  register: authelia_check
  changed_when: false
  failed_when: false  # Don't fail deployment if Authelia isn't running
  tags: health_check

- name: Warn if Authelia is not running
  debug:
    msg: "⚠️  Authelia is not running. Check logs: docker logs authelia"
  when: authelia_check.stdout == ""
  tags: health_check

- name: Check service health endpoints (if accessible)
  uri:
    url: "{{ item.url }}"
    method: GET
    status_code: [200, 401, 403]  # 401/403 are OK for protected endpoints
    timeout: 10
    validate_certs: false  # Allow checking even if certificates aren't ready yet
  loop:
    - { url: "https://auth.{{ domain }}/api/health", name: "Caddy (via Authelia)" }
    - { url: "https://grafana.{{ domain }}/api/health", name: "Grafana" }
    - { url: "https://auth.{{ domain }}/api/health", name: "Authelia" }
  register: health_checks
  ignore_errors: true
  tags: health_check

- name: Display health check results
  debug:
    msg: "{{ item.item.name | default('Unknown') }}: {{ '✅ Healthy' if (item.status | default(-1) == 200) or (item.status | default(-1) == 401) or (item.status | default(-1) == 403) else '⚠️  Check failed (Status: ' + (item.status | default('N/A') | string) + ')' }}"
  loop: "{{ health_checks.results | default([]) }}"
  when: health_checks is defined and health_checks.results is defined
  tags: health_check

- name: Get disk usage
  shell: df -h / | awk 'NR==2 {print $5}'
  register: disk_usage
  changed_when: false
  tags: health_check

- name: Display disk usage
  debug:
    msg: "Disk usage: {{ disk_usage.stdout }}"
  tags: health_check

- name: Fail if disk usage is too high
  fail:
    msg: "Disk usage is too high: {{ disk_usage.stdout }}"
  when: disk_usage.stdout | regex_replace('%', '') | int > 90
  tags: health_check
