##############################################################################
# TRAEFIK - Dynamic Middleware Configuration
# Security headers, rate limiting, and protection middlewares
# This file is templated by Ansible. Do not edit directly.
##############################################################################

http:
  middlewares:
    ##########################################################################
    # CROWDSEC - Threat Intelligence & IDS/IPS
    ##########################################################################
    crowdsec:
      plugin:
        crowdsec:
          clientTrustedIPs:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
            - 100.89.137.0/20
          crowdsecAppsecEnabled: true
          crowdsecAppsecFailureBlock: true
          crowdsecAppsecHost: crowdsec:7422
          crowdsecAppsecUnreachableBlock: true
          crowdsecLapiHost: crowdsec:8080
          crowdsecLapiKey: {{ crowdsec_bouncer_api_key | default('wwheoo2x/Mhk0p/ZW7nKbQl94Zkha1Ij/1jrEr3b2KQ') }}
          crowdsecLapiScheme: http
          crowdsecMode: live
          defaultDecisionSeconds: 15
          enabled: true
          forwardedHeadersTrustedIPs:
            - 0.0.0.0/0
          httpTimeoutSeconds: 10
          logLevel: INFO
          updateIntervalSeconds: 15
          updateMaxFailure: 0

    ##########################################################################
    # SECURITY HEADERS
    ##########################################################################
    security-headers:
      headers:
        # HSTS (HTTP Strict Transport Security)
        stsSeconds: 63072000
        stsIncludeSubdomains: true
        stsPreload: true

        # Force HTTPS
        forceSTSHeader: true

        # Prevent clickjacking
        customFrameOptionsValue: "SAMEORIGIN"

        # Content Security Policy
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'"

        # Additional security headers
        browserXssFilter: true
        contentTypeNosniff: true
        referrerPolicy: "strict-origin-when-cross-origin"
        permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=()"

        # Remove server identification
        customResponseHeaders:
          X-Powered-By: ""
          Server: ""

    ##########################################################################
    # RATE LIMITING
    ##########################################################################
    rate-limit:
      rateLimit:
        average: 100
        period: 1m
        burst: 50
        sourceCriterion:
          ipStrategy:
            depth: 1
            excludedIPs:
              - "127.0.0.1/32"
              - "172.20.0.0/24"
              - "172.21.0.0/24"

    rate-limit-strict:
      rateLimit:
        average: 10
        period: 1m
        burst: 5
        sourceCriterion:
          ipStrategy:
            depth: 1

    rate-limit-api:
      rateLimit:
        average: 300
        period: 1m
        burst: 100
        sourceCriterion:
          ipStrategy:
            depth: 1

    ##########################################################################
    # IP WHITELISTING
    ##########################################################################
    admin-whitelist:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "172.20.0.0/24"
          - "172.21.0.0/24"
          - "100.64.0.0/10" # Tailscale range
          # Add your home/office IP here:
          # - "YOUR_PUBLIC_IP/32"

    local-only:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"
          - "100.64.0.0/10" # Tailscale

    ##########################################################################
    # COMPRESSION
    ##########################################################################
    compression:
      compress:
        excludedContentTypes:
          - "text/event-stream"
        minResponseBodyBytes: 1024

    ##########################################################################
    # ERROR PAGES (Custom)
    ##########################################################################
    custom-error-pages:
      errors:
        status:
          - "400-599"
        service: error-pages
        query: "/{status}.html"

    ##########################################################################
    # BASIC AUTHENTICATION
    ##########################################################################
    # Basic Auth for services accessible via Tailscale
    # Credentials are stored in config/traefik/basic-auth.htpasswd
    # Generate credentials using: htpasswd -nbB username password
    # Or: docker run --rm httpd:alpine htpasswd -nbB username password
    basic-auth:
      basicAuth:
        usersFile: "/etc/traefik/basic-auth.htpasswd"
        realm: "Tailscale Services"
        removeHeader: true

    ##########################################################################
    # REDIRECTS
    ##########################################################################
    # HTTP to HTTPS redirect middleware
    # Redirects to the HTTPS version of the same domain (not a generic redirect)
    # This avoids insecure redirect patterns per SecurityScorecard guidelines:
    # https://support.securityscorecard.com/hc/en-us/articles/360058513252-Insecure-HTTPS-redirect-pattern
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true
        # port: 443  # Optional: explicitly set port if needed

    redirect-to-www:
      redirectRegex:
        regex: "^https://rodneyops.com/(.*)"
        replacement: "https://www.rodneyops.com/${1}"
        permanent: true

    ##########################################################################
    # AUTHENTICATION CHAINS
    ##########################################################################
    auth-chain:
      chain:
        middlewares:
          - crowdsec-bouncer@docker
          - authelia@docker
          - security-headers

    auth-chain-admin:
      chain:
        middlewares:
          - crowdsec-bouncer@docker
          - admin-whitelist
          - authelia@docker
          - security-headers

    ##########################################################################
    # BUFFERING (for large uploads)
    ##########################################################################
    buffering:
      buffering:
        maxRequestBodyBytes: 10485760 # 10MB
        memRequestBodyBytes: 2097152 # 2MB
        maxResponseBodyBytes: 10485760 # 10MB
        memResponseBodyBytes: 2097152 # 2MB
        retryExpression: "IsNetworkError() && Attempts() < 3"

    ##########################################################################
    # CIRCUIT BREAKER (prevent cascading failures)
    ##########################################################################
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.30 || ResponseCodeRatio(500, 600, 0, 600) > 0.25"
        checkPeriod: "10s"
        fallbackDuration: "30s"
        recoveryDuration: "30s"

    ##########################################################################
    # CORS (Cross-Origin Resource Sharing)
    ##########################################################################
    cors-default:
      headers:
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - PUT
          - POST
          - DELETE
        accessControlAllowOriginList:
          - "https://rodneyops.com"
          - "https://*.rodneyops.com"
        accessControlMaxAge: 100
        addVaryHeader: true
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
          - "X-Requested-With"

    ##########################################################################
    # RETRY (for transient failures)
    ##########################################################################
    retry:
      retry:
        attempts: 3
        initialInterval: "100ms"

    ##########################################################################
    # STRIP PREFIX (remove path prefix)
    ##########################################################################
    strip-prefix-api:
      stripPrefix:
        prefixes:
          - "/api"
        forceSlash: false

    ##########################################################################
    # REPLACE PATH
    ##########################################################################
    replace-path-root:
      replacePath:
        path: "/"

    ##########################################################################
    # INFLIGHTREQ (limit concurrent requests)
    ##########################################################################
    inflightreq-limit:
      inFlightReq:
        amount: 50
        sourceCriterion:
          ipStrategy:
            depth: 1

##############################################################################
# TCP MIDDLEWARES (if needed)
##############################################################################
tcp:
  middlewares:
    tcp-ipwhitelist:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "172.20.0.0/16"
          - "100.64.0.0/10"

