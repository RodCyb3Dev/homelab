##############################################################################
# SYNC CONFIG ROLE - Synchronize configuration files
# Preserves existing runtime files (logs, etc.)
##############################################################################

---
- name: Ensure config directories exist on server
  file:
    path: "{{ deploy_path }}/config/{{ item }}"
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'
  loop:
    - tailscale
    - crowdsec
    - grafana
    - grafana/provisioning
    - grafana/provisioning/dashboards
    - grafana/provisioning/datasources
    - prometheus
    - loki
    - promtail
    - fail2ban
    - fail2ban/filter.d
    - immich
    - paperless
    - caddy
    - crowdsec
  tags: sync_config

- name: Sync docker-compose.yml (core)
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.yml"
    dest: "{{ deploy_path }}/docker-compose.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.jellyfin.yml
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.jellyfin.yml"
    dest: "{{ deploy_path }}/docker-compose.jellyfin.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.jellyfin.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.arr-stack.yml
  synchronize:
    src: "{{ inventory_dir }}/../docker-compose.arr-stack.yml"
    dest: "{{ deploy_path }}/docker-compose.arr-stack.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.arr-stack.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.immich.yml
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.immich.yml"
    dest: "{{ deploy_path }}/docker-compose.immich.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.immich.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.pdf.yml
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.pdf.yml"
    dest: "{{ deploy_path }}/docker-compose.pdf.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.pdf.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.monitoring.yml
  synchronize:
    src: "{{ inventory_dir }}/../docker-compose.monitoring.yml"
    dest: "{{ deploy_path }}/docker-compose.monitoring.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.monitoring.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Check which docker-compose files exist
  stat:
    path: "{{ deploy_path }}/{{ item }}"
  register: compose_file_stat
  loop:
    - docker-compose.yml
    - docker-compose.jellyfin.yml
    - docker-compose.arr-stack.yml
    - docker-compose.immich.yml
    - docker-compose.pdf.yml
    - docker-compose.monitoring.yml
  tags: sync_config

- name: Set ownership of docker-compose files
  file:
    path: "{{ deploy_path }}/{{ item.item }}"
    owner: deploy
    group: deploy
    mode: '0644'
  loop: "{{ compose_file_stat.results }}"
  when: item.stat.exists | default(false)
  tags: sync_config

- name: Set ownership of config directory
  file:
    path: "{{ deploy_path }}/config"
    owner: deploy
    group: deploy
    recurse: yes
  tags: sync_config

- name: Sync Caddyfile
  synchronize:
    src: "{{ inventory_dir }}/../Caddyfile"
    dest: "{{ deploy_path }}/Caddyfile"
    mode: push
    perms: yes
  tags: sync_config

- name: Sync configuration files (excluding secrets and runtime data)
  synchronize:
    src: "{{ inventory_dir }}/../config/"
    dest: "{{ deploy_path }}/config/"
    mode: push
    perms: yes
    rsync_opts:
      - "--exclude=*.log"
      - "--exclude=*.gz"
      - "--exclude=*.db"
      - "--exclude=*.sqlite*"
      - "--exclude=*.state"
      - "--exclude=data/"
      - "--exclude=db/"
      - "--exclude=cache/"
      - "--exclude=logs/"
      - "--exclude=*.txt"
      - "--include=**/requirements.txt"
      - "--include=**/Dockerfile"
      - "--exclude=*.key"
      - "--exclude=*.pem"
      - "--exclude=*.crt"
      - "--exclude=traefik/"
      - "--exclude=pangolin/"
      - "--update"
  tags: sync_config

- name: Ensure Immich config directory exists
  file:
    path: "{{ deploy_path }}/config/immich"
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'
  tags: sync_config

- name: Find systemd service files
  find:
    paths: "{{ playbook_dir }}/../systemd"
    patterns: "*.service,*.mount,*.automount"
    file_type: file
  register: systemd_files_found
  tags: sync_config

- name: Deploy systemd service files
  copy:
    src: "{{ item.path }}"
    dest: "/etc/systemd/system/{{ item.path | basename }}"
    mode: '0644'
    owner: root
    group: root
  loop: "{{ systemd_files_found.files }}"
  when: systemd_files_found.files | length > 0
  tags: sync_config

- name: Reload systemd daemon after syncing services
  systemd:
    daemon_reload: yes
  tags: sync_config
