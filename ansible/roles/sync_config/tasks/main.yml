##############################################################################
# SYNC CONFIG ROLE - Synchronize configuration files
# Preserves existing runtime files (logs, etc.)
##############################################################################

---
- name: Ensure config directories exist on server
  file:
    path: "{{ deploy_path }}/config/{{ item }}"
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'
  loop:
    - tailscale
    - crowdsec
    - grafana
    - grafana/provisioning
    - grafana/provisioning/dashboards
    - grafana/provisioning/datasources
    - prometheus
    - loki
    - promtail
    - fail2ban
    - fail2ban/filter.d
    - immich
    - paperless
    - pangolin
  tags: sync_config

- name: Sync docker-compose.yml (core)
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.yml"
    dest: "{{ deploy_path }}/docker-compose.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.jellyfin.yml
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.jellyfin.yml"
    dest: "{{ deploy_path }}/docker-compose.jellyfin.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.jellyfin.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.arr-stack.yml
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.arr-stack.yml"
    dest: "{{ deploy_path }}/docker-compose.arr-stack.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.arr-stack.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.immich.yml
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.immich.yml"
    dest: "{{ deploy_path }}/docker-compose.immich.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.immich.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.pdf.yml
  synchronize:
    src: "{{ playbook_dir }}/../docker-compose.pdf.yml"
    dest: "{{ deploy_path }}/docker-compose.pdf.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.pdf.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Sync docker-compose.monitoring.yml
  synchronize:
    src: "{{ playbook_dir }}/../../docker-compose.monitoring.yml"
    dest: "{{ deploy_path }}/docker-compose.monitoring.yml"
    mode: push
    perms: yes
  when: compose_file_name | default('') == 'docker-compose.monitoring.yml' or compose_file_name | default('') == ''
  tags: sync_config

- name: Check which docker-compose files exist
  stat:
    path: "{{ deploy_path }}/{{ item }}"
  register: compose_file_stat
  loop:
    - docker-compose.yml
    - docker-compose.jellyfin.yml
    - docker-compose.arr-stack.yml
    - docker-compose.immich.yml
    - docker-compose.pdf.yml
    - docker-compose.monitoring.yml
  tags: sync_config

- name: Set ownership of docker-compose files
  file:
    path: "{{ deploy_path }}/{{ item.item }}"
    owner: deploy
    group: deploy
    mode: '0644'
  loop: "{{ compose_file_stat.results }}"
  when: item.stat.exists | default(false)
  tags: sync_config

- name: Set ownership of config directory
  file:
    path: "{{ deploy_path }}/config"
    owner: deploy
    group: deploy
    recurse: yes
  tags: sync_config

- name: Template Pangolin config file (with secrets from environment)
  template:
    src: pangolin-config.yml.j2
    dest: "{{ deploy_path }}/config/pangolin/config.yml"
    owner: deploy
    group: deploy
    mode: '0644'
  vars:
    _smtp_host: "{{ lookup('env', 'SMTP_HOST') | default(vault_smtp_host | default(''), true) }}"
    pangolin_smtp_host: "{{ (_smtp_host | length > 0) | ternary(_smtp_host, 'smtp.protonmail.ch') }}"
    _smtp_port: "{{ lookup('env', 'SMTP_PORT') | default(vault_smtp_port | default(''), true) }}"
    pangolin_smtp_port: "{{ (_smtp_port | length > 0) | ternary(_smtp_port | int, 587) }}"
    _smtp_user: "{{ lookup('env', 'SMTP_USER') | default(vault_smtp_username | default(''), true) }}"
    pangolin_smtp_user: "{{ (_smtp_user | length > 0) | ternary(_smtp_user, 'info@kodeflash.dev') }}"
    pangolin_smtp_pass: "{{ lookup('env', 'SMTP_PASSWORD') | default(vault_smtp_password | default(''), true) }}"
    _no_reply: "{{ lookup('env', 'NO_REPLY_EMAIL') | default(vault_no_reply_email | default(''), true) }}"
    pangolin_no_reply_email: "{{ (_no_reply | length > 0) | ternary(_no_reply, 'no-reply@kodeflash.dev') }}"
    _admin_email: "{{ lookup('env', 'PANGOLIN_ADMIN_EMAIL') | default(vault_pangolin_admin_email | default(''), true) }}"
    pangolin_admin_email: "{{ (_admin_email | length > 0) | ternary(_admin_email, 'rodney@kodeflash.dev') }}"
    pangolin_admin_password: "{{ lookup('env', 'PANGOLIN_ADMIN_PASSWORD') | default(vault_pangolin_admin_password | default(''), true) }}"
  no_log: false
  tags: sync_config

- name: Template Traefik middlewares.yml (with CrowdSec API key from vault)
  template:
    src: middlewares.yml.j2
    dest: "{{ deploy_path }}/config/traefik/dynamic/middlewares.yml"
    owner: deploy
    group: deploy
    mode: '0644'
  vars:
    crowdsec_bouncer_api_key: "{{ lookup('env', 'CROWDSEC_BOUNCER_KEY') | default(vault_crowdsec_bouncer_key | default('wwheoo2x/Mhk0p/ZW7nKbQl94Zkha1Ij/1jrEr3b2KQ')) }}"
  no_log: true
  tags: sync_config

- name: Sync configuration files (excluding secrets and runtime data)
  synchronize:
    src: "{{ inventory_dir }}/../config/"
    dest: "{{ deploy_path }}/config/"
    mode: push
    perms: yes
    rsync_opts:
      - "--exclude=*.log"
      - "--exclude=*.gz"
      - "--exclude=*.db"
      - "--exclude=*.sqlite*"
      - "--exclude=*.state"
      - "--exclude=data/"
      - "--exclude=db/"
      - "--exclude=cache/"
      - "--exclude=logs/"
      - "--exclude=*.txt"
      - "--exclude=*.key"
      - "--exclude=*.pem"
      - "--exclude=*.crt"
      - "--exclude=pangolin/config.yml"
      - "--exclude=traefik/dynamic/middlewares.yml"
      - "--update"
  tags: sync_config

- name: Ensure Immich config directory exists
  file:
    path: "{{ deploy_path }}/config/immich"
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'
  tags: sync_config
